<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel to HTML preview</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    :root {
      color-scheme: light;
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-solid: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --border: #e2e8f0;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-solid);
      background-image: var(--bg);
      background-attachment: fixed;
      color: var(--text);
      padding: 24px;
      margin: 0;
      min-height: 100vh;
      line-height: 1.6;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 { 
      font-size: 28px; 
      font-weight: 700;
      margin: 0 0 8px;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .sub { 
      color: rgba(255,255,255,0.9); 
      margin: 0 0 24px;
      font-size: 15px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 60px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      box-shadow: 0 24px 80px -12px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.05);
    }
    .card h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 16px;
      color: var(--text);
    }
    .controls {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      align-items: start;
      margin-bottom: 20px;
    }
    label { 
      font-weight: 600; 
      display: block; 
      margin-bottom: 8px;
      color: var(--text);
      font-size: 14px;
    }
    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: #fff;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
    }
    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    button {
      width: 100%;
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      font-family: inherit;
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }
    button:active { 
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .status { 
      margin-top: 16px; 
      margin-bottom: 16px;
      color: var(--text);
      font-size: 16px;
      font-weight: 600;
      padding: 16px 20px;
      background: #f0f9ff;
      border-radius: 10px;
      border-left: 5px solid var(--accent);
      white-space: pre-wrap;
      word-wrap: break-word;
      min-height: 30px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      /* display: none-–∏–π–≥ –∞—Ä–∏–ª–≥–∞—Å–∞–Ω, JavaScript –¥—ç—ç—Ä —É–¥–∏—Ä–¥–∞—Ö */
    }
    
    .status:empty {
      display: none;
    }
    .error { 
      color: var(--error);
      font-weight: 700;
      background: #fef2f2;
      padding: 16px 20px;
      border-radius: 10px;
      border-left: 5px solid var(--error);
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      line-height: 1.5;
      white-space: pre-line;
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      background: #fff; 
      border-radius: 12px; 
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    th, td { 
      border: 1px solid var(--border); 
      padding: 12px 14px; 
      font-size: 14px;
    }
    th { 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      text-align: left;
      font-weight: 600;
      color: var(--text);
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }
    tbody tr {
      transition: background-color 0.15s ease;
    }
    tbody tr:nth-child(odd) { 
      background: #fafbfc;
    }
    tbody tr:hover {
      background: #f1f5f9;
    }
    .table-wrap { 
      overflow: auto; 
      border-radius: 12px; 
      border: 1px solid var(--border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .filters { 
      display: grid; 
      gap: 12px; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      margin: 16px 0 8px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
      border: 2px solid var(--border);
      padding: 8px 14px;
      border-radius: 20px;
      background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
      font-weight: 500;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 12px 16px;
      width: 100%;
    }
    .detail-grid .label {
      font-weight: 600;
      color: var(--muted);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .detail-grid .value {
      background: #f8fafc;
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      min-height: 24px;
      word-break: break-word;
      font-size: 14px;
    }
    .detail-empty { 
      color: #94a3b8; 
      font-style: italic;
    }
    .tabs {
      display: inline-flex;
      gap: 8px;
      margin: 0 0 24px;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 6px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .tab {
      border: none;
      background: transparent;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      color: rgba(255,255,255,0.8);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    .tab:hover {
      color: #fff;
      background: rgba(255,255,255,0.1);
    }
    .tab.active { 
      background: #fff;
      color: var(--accent);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .hidden { display: none; }
    .tip-text {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      padding: 8px 12px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 3px solid var(--accent);
    }
    input[type="number"],
    input[type="text"],
    .editable-input {
      width: 100%;
      padding: 6px 10px;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: #fff;
      color: var(--text);
      transition: all 0.2s ease;
      box-sizing: border-box;
    }
    input[type="number"],
    .editable-input[type="number"] {
      text-align: center;
    }
    input[type="number"]:focus,
    input[type="text"]:focus,
    .editable-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    input[type="number"]:hover,
    input[type="text"]:hover,
    .editable-input:hover {
      border-color: var(--accent-hover);
    }
    td input,
    td .editable-input {
      margin: 0;
      width: 100%;
      min-width: 80px;
    }
  </style>
  <!-- SheetJS CDN for reading Excel files -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <!-- Google API JavaScript client library -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
</head>
 <body>
   <div class="container" id="main-content">
    <div style="margin-bottom: 16px;">
      <h1 style="margin: 0 0 8px;">üìä –†–•–ê–•–¢–ê –†–•–ê-–ù —Ç–∞–≤–∏–ª—ã–Ω –∫–∞—Ä—Ç</h1>
      <p class="sub" style="margin: 0;">–ë–æ–ª–æ–º–∂–≥“Ø–π –∑“Ø–π–ª –≥—ç–∂ –±–∞–π—Ö–≥“Ø–π.</p>
    </div>
     <div class="tabs">
       <button class="tab active" id="tab-home">üè† –ù“Ø“Ø—Ä</button>
       <button class="tab" id="tab-card">üìä –¢–∞–≤–∏–ª—ã–Ω –∫–∞—Ä—Ç</button>
       <button class="tab" id="tab-pdf">üìÑ –î—ç–¥ —Å—Ç–∞–Ω—Ü—ã–Ω —Å—Ö–µ–º</button>
     </div>

  <div id="view-section">
  <div class="card">
    <div class="controls">
      <div>
        <label>–î—ç–¥ —Å—Ç–∞–Ω—Ü</label>
        <select id="google-sheets-url" style="width: 100%; padding: 12px 16px; border-radius: 10px; border: 2px solid var(--border); background: #fff; color: var(--text); font-size: 14px; font-family: inherit; transition: all 0.2s ease;">
          <option value="https://docs.google.com/spreadsheets/d/1l_avCSP5aogtMvHYr2IL9vz3WY8ToYvBp-el28rI4Z0/edit?pli=1&gid=1366441472#gid=1366441472">–ë—É—è–Ω—Ç –£—Ö–∞–∞</option>
        </select>
         <button id="login-google" style="margin-top: 8px; background: var(--accent); color: white;">üîê Google-–¥ –Ω—ç–≤—Ç—Ä—ç—Ö</button>
         <button id="load-google-sheets" style="margin-top: 8px;">üì• Google Sheets —É–Ω—à–∏—Ö</button>
         <p class="tip-text">üí° –ó”©–≤–ª”©–º–∂: –≠—Ö–ª—ç—ç–¥ "Google-–¥ –Ω—ç–≤—Ç—Ä—ç—Ö" –¥–∞—Ä–∞–∞–¥, –¥–∞—Ä–∞–∞–≥–∏–π–Ω —É–Ω—à–∏–ª—Ç/–±–∏—á–∏–ª—Ç —Ö—É—Ä–¥–∞–Ω –±–æ–ª–Ω–æ</p>
         <details style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid var(--border);">
           <summary style="cursor: pointer; font-weight: 600; color: var(--text);">‚ö° –û–ª–æ–Ω —à–∞—Ç–ª–∞–ª—Ç –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–ª—Ç—ã–≥ –±–∞–≥–∞—Å–≥–∞—Ö</summary>
           <div style="margin-top: 12px; padding-left: 8px; font-size: 13px; color: var(--muted); line-height: 1.8;">
             <p><strong>Google-–¥ –Ω—ç–≤—Ç—Ä—ç—Ö—ç–¥ –æ–ª–æ–Ω —à–∞—Ç–ª–∞–ª—Ç –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–ª—Ç —Ö–∏–π—Ö–≥“Ø–π –±–∞–π—Ö:</strong></p>
             <ul style="margin-left: 20px; margin-top: 8px;">
               <li><strong>1. OAuth Consent Screen-–∏–π–≥ –±“Ø—Ä—ç–Ω verification —Ö–∏–π—Ö (–ó”®–í–õ”®–ú–ñ):</strong></li>
               <li style="margin-left: 20px;">Google Cloud Console ‚Üí OAuth consent screen ‚Üí "PUBLISH APP" ‚Üí Verification —Ö–∏–π—Ö</li>
               <li style="margin-left: 20px;">Verification –¥—É—É—Å—Å–∞–Ω—ã –¥–∞—Ä–∞–∞ –æ–ª–æ–Ω —à–∞—Ç–ª–∞–ª—Ç –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–ª—Ç –∞–ª–≥–∞ –±–æ–ª–Ω–æ</li>
               
               <li style="margin-top: 12px;"><strong>2. Test User –∞—à–∏–≥–ª–∞—Ö (–•—É—Ä–¥–∞–Ω –∞—Ä–≥–∞):</strong></li>
               <li style="margin-left: 20px;">OAuth consent screen ‚Üí "Test users" ‚Üí Email –Ω—ç–º—ç—Ö</li>
               <li style="margin-left: 20px;">Test user-—ç—ç—Ä –Ω—ç–≤—Ç—Ä—ç—Ö—ç–¥ –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–ª—Ç –±–∞–≥–∞</li>
               
               <li style="margin-top: 12px;"><strong>3. –û–¥–æ–æ–≥–∏–π–Ω –±–∞–π–¥–∞–ª:</strong></li>
               <li style="margin-left: 20px;">Token —Ö–∞–¥–≥–∞–ª–∞–≥–¥—Å–∞–Ω —Ç—É–ª –¥–∞—Ä–∞–∞–≥–∏–π–Ω —É–¥–∞–∞–¥ –Ω—ç–≤—Ç—Ä—ç—Ö–≥“Ø–π (1 —É–¥–∞–∞ –ª –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–Ω–∞)</li>
               <li style="margin-left: 20px;">Browser-–∏–π–Ω cookie/session —Ö–∞–¥–≥–∞–ª–∞–≥–¥—Å–∞–Ω –±–∞–π–≤–∞–ª –∏–ª“Ø“Ø —Ö—É—Ä–¥–∞–Ω</li>
             </ul>
           </div>
         </details>
         <details style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid var(--border);">
           <summary style="cursor: pointer; font-weight: 600; color: var(--text);">üîí Restricted Google Sheets —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö</summary>
           <div style="margin-top: 12px; padding-left: 8px; font-size: 13px; color: var(--muted); line-height: 1.8;">
             <p><strong>1. Google Sheets-–∏–π–≥ Restricted –±–æ–ª–≥–æ—Ö:</strong></p>
             <ul style="margin-left: 20px; margin-top: 8px;">
               <li>Google Sheets ‚Üí <strong>Share</strong> —Ç–æ–≤—á –¥–∞—Ä–∞—Ö</li>
               <li><strong>"Restrict"</strong> —Å–æ–Ω–≥–æ—Ö (—ç—Å–≤—ç–ª "Change to restricted" / "–•—è–∑–≥–∞–∞—Ä–ª–∞—Ö")</li>
               <li><strong>"Editor"</strong> —ç—Ä—Ö—Ç—ç–π email address-—É—É–¥ –Ω—ç–º—ç—Ö</li>
             </ul>
             
             <p style="margin-top: 16px;"><strong>2. Application-–∞–∞—Å —Ö–∞–Ω–¥–∞—Ö:</strong></p>
             <ul style="margin-left: 20px; margin-top: 8px;">
               <li>"Google-–¥ –Ω—ç–≤—Ç—Ä—ç—Ö" —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–∞—Ö–∞–¥ <strong>Share –¥—ç—ç—Ä –Ω—ç–º—Å—ç–Ω email-—ç—ç—Ä—ç—ç</strong> –Ω—ç–≤—Ç—ç—Ä–Ω—ç “Ø“Ø</li>
               <li>–•—ç—Ä—ç–≤ ”©”©—Ä email-—ç—ç—Ä –Ω—ç–≤—Ç—ç—Ä—Å—ç–Ω –±–æ–ª Google Sheets —Ö–∞–Ω–¥–∞–ª—Ç “Ø–≥“Ø–π –±–æ–ª–Ω–æ</li>
               <li>Share ‚Üí <strong>"Editor"</strong> —ç—Ä—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π (—É–Ω—à–∏—Ö, –±–∏—á–∏—Ö –∞–ª—å –∞–ª—å –Ω—å)</li>
             </ul>
             
             <p style="margin-top: 16px;"><strong>3. –ê–ª–¥–∞–∞ –≥–∞—Ä–≤–∞–ª:</strong></p>
             <ul style="margin-left: 20px; margin-top: 8px;">
               <li>"403 Forbidden" –∞–ª–¥–∞–∞ ‚Üí Share –¥—ç—ç—Ä email-–∏–π–≥ –Ω—ç–º—ç—ç–≥“Ø–π —ç—Å–≤—ç–ª "Viewer" —ç—Ä—Ö ”©–≥—Å”©–Ω</li>
               <li>–®–∏–π–¥—ç–ª: Share ‚Üí Email-–∏–π–≥ –Ω—ç–º—ç—ç–¥ <strong>"Editor"</strong> —ç—Ä—Ö ”©–≥”©—Ö</li>
             </ul>
           </div>
         </details>
      </div>
      <div>
        <label>Google OAuth 2.0 Client ID (–•–∞–¥–≥–∞–ª–∞—Ö–∞–¥ —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π)</label>
        <input id="google-api-key" type="text" value="298828856664-7phl22m56lopgbga190r6f2rjthvidc2.apps.googleusercontent.com" placeholder="YOUR_CLIENT_ID.apps.googleusercontent.com" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;" />
         <p class="tip-text">üí° Google Cloud Console ‚Üí API & Services ‚Üí Credentials ‚Üí OAuth 2.0 Client ID “Ø“Ø—Å–≥—ç—Ö</p>
      </div>
      <div>
        <label>Sheet (—Ö—É—É–¥–∞—Å)</label>
        <select id="sheet-select"></select>
      </div>
      <div>
        <label>–¢–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –Ω—ç—Ä</label>
        <select id="equipment-select" style="width: 100%; padding: 12px 16px; border-radius: 10px; border: 2px solid var(--border); background: #fff; color: var(--text); font-size: 14px; font-family: inherit; transition: all 0.2s ease;">
          <option value="__all__">–ë“Ø–≥–¥</option>
        </select>
      </div>
    </div>
    <div class="filters">
      <div class="pill" id="summary-pill">–ú—ç–¥—ç—ç–ª—ç–ª —Ö–∞—Ä–∞–∞—Ö–∞–Ω —É–Ω—à–∞–∞–≥“Ø–π –±–∞–π–Ω–∞</div>
    </div>
    <div id="status" class="status"></div>
  </div>

  </div>

  <!-- PDF —Ñ–∞–π–ª—ã–≥ —Ö–∞—Ä—É—É–ª–∞—Ö —Ö—ç—Å—ç–≥ -->
  <div id="pdf-section" class="card" style="margin-top: 24px; display: none;">
    <h3 style="margin: 0 0 16px;">–î—ç–¥ —Å—Ç–∞–Ω—Ü—ã–Ω —Å—Ö–µ–º</h3>
    <div style="width: 100%; height: 800px; border: 2px solid var(--border); border-radius: 12px; overflow: hidden;">
      <iframe id="pdf-viewer" src="" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
  </div>

  <div id="history-section">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h3 style="margin: 0;">–¢“Ø“Ø—Ö / –®“Ø“Ø—Å—ç–Ω —Ö“Ø—Å–Ω—ç–≥—Ç</h3>
        <div style="display:flex;gap:8px;">
          <button id="save-to-google-sheets">‚òÅÔ∏è Google Sheets –¥—ç—ç—Ä —Ö–∞–¥–≥–∞–ª–∞—Ö</button>
          <button id="download-updated">üíæ Excel —Ñ–∞–π–ª —Ö–∞–¥–≥–∞–ª–∞—Ö</button>
        </div>
      </div>
      <div class="table-wrap" id="history-table-container"></div>
    </div>
  </div>

  <script>

    const googleSheetsUrlInput = document.getElementById("google-sheets-url");
    const loadGoogleSheetsBtn = document.getElementById("load-google-sheets");
    const sheetSelect = document.getElementById("sheet-select");
    const statusEl = document.getElementById("status");
    const tableContainer = document.createElement("div"); // not shown in UI, used for history copy
    const equipmentSelect = document.getElementById("equipment-select");
    const summaryPill = document.getElementById("summary-pill");
    const detailContainer = null; // "–°–æ–Ω–≥–æ—Å–æ–Ω —Ç–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π" —Ö—ç—Å—ç–≥ —É—Å—Ç–≥–∞–≥–¥—Å–∞–Ω
    const historyTableContainer = document.getElementById("history-table-container");
    const downloadBtn = document.getElementById("download-updated");
    const saveToGoogleSheetsBtn = document.getElementById("save-to-google-sheets");
    const googleApiKeyInput = document.getElementById("google-api-key");
    const viewSection = document.getElementById("view-section");
    const historySection = document.getElementById("history-section");

    let workbook = null;
    let sheetData = [];
    let equipmentField = null;
    let headers = [];
    let viewHeaders = [];
    let combine78 = false; // 7+8-–≥ –Ω—ç–≥—Ç–≥—ç—Ö–≥“Ø–π, —Å–∞–ª–≥–∞—Å–∞–Ω –≥–æ—Ä–∏–º
    const editableFieldName = "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞ ”©”©—Ä—á”©—Ö";
    let originalFileName = null; // Google Sheets –Ω—ç—Ä
    let googleSheetId = null; // Google Sheets ID (—Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞—à–∏–≥–ª–∞–Ω–∞)
    let googleSheetGid = "0"; // Google Sheets GID (—Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞—à–∏–≥–ª–∞–Ω–∞)
    let sheetNameToGidMap = {}; // Sheet name -> GID mapping (—Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞—à–∏–≥–ª–∞–Ω–∞)
    let footerData = []; // Footer –º”©—Ä“Ø“Ø–¥ (15-18-—Ä –º”©—Ä“Ø“Ø–¥)
    let headerRowIndex = 1; // Google Sheets –¥—ç—ç—Ä—Ö header –º”©—Ä–∏–π–Ω –¥—É–≥–∞–∞—Ä (1-based, default = row 1)

    const clearTable = () => { tableContainer.innerHTML = ""; };
    const clearHistoryTable = () => { historyTableContainer.innerHTML = ""; };

    const showError = (msg) => {
      if (!msg || msg.trim() === "") {
        if (statusEl) {
          statusEl.innerHTML = "";
          statusEl.style.display = "none";
        }
        return;
      }
      
      // Alert —Ö–∞—Ä—É—É–ª–∞—Ö (—Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–¥ —Ç–æ–¥–æ—Ä—Ö–æ–π —Ö–∞—Ä–∞–≥–¥–∞—Ö)
      alert(`‚ùå –ê–õ–î–ê–ê\n\n${msg}`);
      
      // Status element –¥—ç—ç—Ä –º”©–Ω —Ö–∞—Ä—É—É–ª–∞—Ö
      if (statusEl) {
        statusEl.innerHTML = `<div class="error">${msg.replace(/\n/g, "<br>")}</div>`;
        statusEl.style.display = "block";
        // Scroll to status element
        statusEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    };

    const setStatus = (msg) => {
      if (!statusEl) {
        console.error("statusEl –æ–ª–¥—Å–æ–Ω–≥“Ø–π!");
        return;
      }
      
      if (!msg || msg.trim() === "") {
        statusEl.innerHTML = "";
        statusEl.style.display = "none";
      } else {
        statusEl.innerHTML = msg.replace(/\n/g, "<br>");
        statusEl.style.display = "block";
      }
    };

    const mergeColumns = (rows, currentHeaders, colsToMerge, newName) => {
      const indices = colsToMerge.map(c => currentHeaders.indexOf(c)).filter(i => i >= 0);
      if (!indices.length) return { headers: currentHeaders, rows };

      const firstIdx = Math.min(...indices);
      // Remove any existing newName to avoid duplicates
      let baseHeaders = currentHeaders.filter(h => h !== newName && !colsToMerge.includes(h));
      baseHeaders.splice(firstIdx, 0, newName);

      const newRows = rows.map(r => {
        const combined = colsToMerge
          .map(c => (r[c] ?? "").toString().trim())
          .filter(Boolean)
          .join(" / ");
        const obj = {};
        baseHeaders.forEach(h => {
          if (h === newName) obj[h] = combined;
          else obj[h] = r[h];
        });
        obj.__rowIndex = r.__rowIndex;
        return obj;
      });
      return { headers: baseHeaders, rows: newRows };
    };

    const buildViewData = (data) => {
      let currentHeaders = [...headers];
      let currentRows = data.map(r => ({ ...r }));

      // Always merge 8-10 into editable field name if present
      const cols810 = ["–ö–æ–ª–æ–Ω-8", "–ö–æ–ª–æ–Ω-9", "–ö–æ–ª–æ–Ω-10"];
      if (cols810.some(c => currentHeaders.includes(c))) {
        const merged = mergeColumns(currentRows, currentHeaders, cols810, editableFieldName);
        currentHeaders = merged.headers;
        currentRows = merged.rows;
      }

      viewHeaders = currentHeaders;
      return currentRows;
    };

    const renderTable = (data) => {
      if (!data?.length) {
        const emptyMsg = `
          <div style="padding: 40px; text-align: center; color: var(--muted);">
            <p style="font-size: 18px; margin-bottom: 8px;">üìã –•“Ø—Å–Ω—ç–≥—Ç —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞</p>
            <p style="font-size: 14px;">”®–≥”©–≥–¥”©–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π. Google Sheets-—ç—ç—Å ”©–≥”©–≥–¥”©–ª —É–Ω—à—É—É–ª–∞–∞—Ä–∞–π.</p>
          </div>
        `;
        tableContainer.innerHTML = emptyMsg;
        historyTableContainer.innerHTML = emptyMsg;
        return;
      }
      const processed = buildViewData(data);
      console.log("Processed data:", processed.slice(0, 3));
      console.log("View headers:", viewHeaders);
      
      // "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—É—É–¥—ã–≥ —à–∞–ª–≥–∞—Ö
      const tavlynUtgaIndex = viewHeaders.findIndex(h => /—Ç–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞/i.test(h));
      if (tavlynUtgaIndex >= 0) {
        const tavlynUtgaHeader = viewHeaders[tavlynUtgaIndex];
        console.log("–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞ –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—É—É–¥:", processed.map(r => ({ 
          value: r[tavlynUtgaHeader], 
          type: typeof r[tavlynUtgaHeader],
          raw: r[tavlynUtgaHeader]
        })).slice(0, 10));
        console.log("–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞ –±–∞–≥–∞–Ω—ã–Ω header:", tavlynUtgaHeader);
        console.log("–≠—Ö–Ω–∏–π –º”©—Ä–∏–π–Ω –±“Ø—Ö —É—Ç–≥—É—É–¥:", processed[0]);
      }
      // Header render —Ö–∏–π—Ö - "”®”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥"-–∏–π–≥ "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –±–æ–ª–≥–æ—Ö
      // –ì—ç—Ö–¥—ç—ç "”®”©—Ä—á–ª”©–ª—Ç 1", "”®”©—Ä—á–ª”©–ª—Ç 2" –≥—ç—Ö –º—ç—Ç –±–∞–≥–∞–Ω—É—É–¥—ã–≥ ”©”©—Ä—á–ª”©—Ö–≥“Ø–π
      // –ú”©–Ω "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" header –∞–ª—å —Ö—ç–¥–∏–π–Ω –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö
      const hasTavilOruulah = viewHeaders.some(h => /^—Ç–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö$/i.test((h || "").toString().trim()));
      
      const displayHeaders = viewHeaders.map(h => {
        const headerStr = (h || "").toString().trim();
        // –ó”©–≤—Ö”©–Ω "”®”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥" –±–∞–≥–∞–Ω—ã–≥ "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –±–æ–ª–≥–æ—Ö
        // –ì—ç—Ö–¥—ç—ç "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" header –∞–ª—å —Ö—ç–¥–∏–π–Ω –±–∞–π–≥–∞–∞ –±–æ–ª ”©”©—Ä—á–ª”©—Ö–≥“Ø–π
        // "”®”©—Ä—á–ª”©–ª—Ç 1", "”®”©—Ä—á–ª”©–ª—Ç 2" –≥—ç—Ö –º—ç—Ç –±–∞–≥–∞–Ω—É—É–¥—ã–≥ ”©”©—Ä—á–ª”©—Ö–≥“Ø–π
        if (/^”©”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥$/i.test(headerStr) && !hasTavilOruulah) {
          return "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö";
        }
        return h;
      });
      const thead = `<thead><tr>${displayHeaders.map(h => `<th>${h}</th>`).join("")}</tr></thead>`;
      
      // Debug: viewHeaders-–¥ "”©”©—Ä—á–ª”©–ª—Ç" –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö
      // –ë“Ø—Ö —Ö—É–≤–∏–ª–±–∞—Ä—É—É–¥—ã–≥ —à–∞–ª–≥–∞—Ö: "”©”©—Ä—á–ª”©–ª—Ç", "”©”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥", "”©”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥" –≥—ç—Ö –º—ç—Ç
      const oorchloltHeaderIndex = viewHeaders.findIndex(h => {
        const headerStr = (h || "").toString().trim().toLowerCase();
        return /”©”©—Ä—á–ª”©–ª—Ç/i.test(headerStr);
      });
      
      console.log("Editable –±–∞–≥–∞–Ω–∞ —à–∞–ª–≥–∞–ª—Ç:", {
        viewHeaders,
        viewHeadersDetailed: viewHeaders.map((h, i) => ({ index: i, name: h, test: /”©”©—Ä—á–ª”©–ª—Ç/i.test(h || "") })),
        oorchloltHeaderIndex,
        oorchloltHeader: oorchloltHeaderIndex >= 0 ? viewHeaders[oorchloltHeaderIndex] : "–û–ª–¥—Å–æ–Ω–≥“Ø–π"
      });
      
      // Sheet-–∏–π–Ω –Ω—ç—Ä—ç–Ω–¥ "IP" –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö (renderTable —Ñ—É–Ω–∫—Ü –¥–æ—Ç–æ—Ä —ç—Ö—ç–ª–∂ —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ—Ö)
      const currentSheetName = sheetSelect.value || "";
      const isIPSheet = /IP/i.test(currentSheetName);
      
      // –•—ç—Ä—ç–≤ "”©”©—Ä—á–ª”©–ª—Ç" header –æ–ª–¥–æ—Ö–≥“Ø–π –±–æ–ª, —Å“Ø“Ø–ª–∏–π–Ω –±–∞–≥–∞–Ω—ã–≥ editable –±–æ–ª–≥–æ—Ö (fallback)
      // IP sheet-–∏–π–Ω —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥ —ç–Ω—ç warning —Ö—ç–≤–ª—ç—Ö–≥“Ø–π
      if (oorchloltHeaderIndex < 0 && !isIPSheet) {
        console.warn("'”©”©—Ä—á–ª”©–ª—Ç' header –æ–ª–¥—Å–æ–Ω–≥“Ø–π! –°“Ø“Ø–ª–∏–π–Ω –±–∞–≥–∞–Ω—ã–≥ editable –±–æ–ª–≥–æ—Ö fallback –∞—à–∏–≥–ª–∞–∂ –±–∞–π–Ω–∞.");
      }
      
      // Merge –ª–æ–≥–∏–∫ —É—Å—Ç–≥–∞—Å–∞–Ω - –±“Ø—Ö cell-“Ø“Ø–¥ —Ö—ç–≤–∏–π–Ω —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
      const rows = processed.map((row, rowIdx) => {
        let rowHtml = '<tr>';
        
        viewHeaders.forEach((h, colIdx) => {
          let val = row[h];
          
          // Value-–≥ string –±–æ–ª–≥–æ—Ö
          if (val === null || val === undefined) {
            val = "";
          } else {
            val = String(val);
          }
          // "–•–æ–æ—Å–æ–Ω" –≥—ç—Å—ç–Ω —É—Ç–≥—ã–≥ —Ö–æ–æ—Å–æ–Ω string –±–æ–ª–≥–æ—Ö
          if (val.trim().toLowerCase() === "—Ö–æ–æ—Å–æ–Ω" || val.trim() === "XOOCOH") {
            val = "";
          }
          
          // –ó”©–≤—Ö”©–Ω "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" (”©”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥) –±–∞–≥–∞–Ω—ã–≥ –∑–∞—Å–≤–∞—Ä–ª–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π
          // "”®”©—Ä—á–ª”©–ª—Ç 1", "”®”©—Ä—á–ª”©–ª—Ç 2" –≥—ç—Ö –º—ç—Ç –±–∞–≥–∞–Ω—É—É–¥ read-only –±–∞–π—Ö —ë—Å—Ç–æ–π
          const headerStr = (h || "").toString().trim();
          
          // "”®”©—Ä—á–ª”©–ª—Ç 1", "”®”©—Ä—á–ª”©–ª—Ç 2" –≥—ç—Ö –º—ç—Ç –±–∞–≥–∞–Ω—É—É–¥—ã–≥ —à–∞–ª–≥–∞—Ö (read-only)
          const isOorchloltVersion = /^”©”©—Ä—á–ª”©–ª—Ç\s+\d+$/i.test(headerStr);
          
          // "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" (”©”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥) –±–∞–≥–∞–Ω—ã–≥ editable –±–æ–ª–≥–æ—Ö
          // –ì—ç—Ö–¥—ç—ç "”®”©—Ä—á–ª”©–ª—Ç 1", "”®”©—Ä—á–ª”©–ª—Ç 2" –≥—ç—Ö –º—ç—Ç –±–∞–≥–∞–Ω—É—É–¥ –±–∏—à
          // –•—ç—Ä—ç–≤ IP sheet –±–æ–ª —ç—Ö–Ω–∏–π 2 –±–∞–≥–∞–Ω–∞–∞—Å –±—É—Å–∞–¥ –±–∞–≥–∞–Ω—É—É–¥—ã–≥ editable –±–æ–ª–≥–æ—Ö
          let isEditable = false;
          
          if (isIPSheet) {
            // IP sheet: —ç—Ö–Ω–∏–π 3 –±–∞–≥–∞–Ω–∞–∞—Å –±—É—Å–∞–¥ –±–∞–≥–∞–Ω—É—É–¥—ã–≥ editable –±–æ–ª–≥–æ—Ö
            if (colIdx >= 3) {
              isEditable = true;
            }
          } else {
            // –ë—É—Å–∞–¥ sheet: –∑”©–≤—Ö”©–Ω "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –±–∞–≥–∞–Ω—ã–≥ editable –±–æ–ª–≥–æ—Ö
            if (!isOorchloltVersion) {
              // "”©”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥" —ç—Å–≤—ç–ª "—Ç–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –≥—ç—Å—ç–Ω header-–∏–π–≥ –æ–ª–æ—Ö
              isEditable = /^”©”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥$/i.test(headerStr) || 
                          /^—Ç–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö$/i.test(headerStr) ||
                          (oorchloltHeaderIndex >= 0 && colIdx === oorchloltHeaderIndex);
              
              // Fallback: —Ö—ç—Ä—ç–≤ "”©”©—Ä—á–ª”©–ª—Ç" header –æ–ª–¥–æ—Ö–≥“Ø–π –±–æ–ª, —Å“Ø“Ø–ª–∏–π–Ω –±–∞–≥–∞–Ω—ã–≥ editable –±–æ–ª–≥–æ—Ö
              // –ì—ç—Ö–¥—ç—ç –∑”©–≤—Ö”©–Ω "”®”©—Ä—á–ª”©–ª—Ç N" –±–∏—à –±–∞–≥–∞–Ω–∞
              if (!isEditable && oorchloltHeaderIndex < 0 && colIdx === viewHeaders.length - 1 && !isOorchloltVersion) {
                isEditable = true;
                console.log("Fallback: –°“Ø“Ø–ª–∏–π–Ω –±–∞–≥–∞–Ω—ã–≥ editable –±–æ–ª–≥–æ–∂ –±–∞–π–Ω–∞:", {
                  header: h,
                  colIdx,
                  viewHeadersLength: viewHeaders.length
                });
              }
            }
          }
          
          // Debug: —ç—Ö–Ω–∏–π –º”©—Ä”©–Ω–¥ editable –±–∞–≥–∞–Ω–∞ —à–∞–ª–≥–∞—Ö
          if (rowIdx === 0 && (colIdx === 0 || colIdx === oorchloltHeaderIndex)) {
            console.log("Editable –±–∞–≥–∞–Ω–∞ —à–∞–ª–≥–∞–ª—Ç (—ç—Ö–Ω–∏–π –º”©—Ä):", {
              header: h,
              colIdx,
              oorchloltHeaderIndex,
              isEditable,
              viewHeaders,
              test1: /”©”©—Ä—á–ª”©–ª—Ç/i.test(h),
              test2: (oorchloltHeaderIndex >= 0 && colIdx === oorchloltHeaderIndex)
            });
          }
          
          const valStr = String(val || "").trim();
          const escapedVal = valStr.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          
          if (isEditable) {
            // "”©”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥" –±–∞–≥–∞–Ω–∞ (–æ–¥–æ–æ "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –≥—ç–∂ —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞) - –∑–∞—Å–≤–∞—Ä–ª–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π
            const finalValue = escapedVal || "";
            // –ê–Ω—Ö–Ω—ã —É—Ç–≥—ã–≥ data attribute-–æ–æ—Ä —Ö–∞–¥–≥–∞–ª–∞—Ö (IP sheet-–∏–π–Ω —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥ —Ö–∞–¥–≥–∞–ª–∞—Ö –ª–æ–≥–∏–∫—Ç –∞—à–∏–≥–ª–∞–Ω–∞)
            const initialValueAttr = finalValue.replace(/"/g, '&quot;');
            // Input field-–¥ disabled —ç—Å–≤—ç–ª readonly attribute –±–∞–π—Ö–≥“Ø–π –±–∞–π—Ö —ë—Å—Ç–æ–π
            rowHtml += `<td><input type="text" data-row="${row.__rowIndex}" data-field="${h}" data-initial-value="${initialValueAttr}" value="${finalValue}" class="editable-input" style="width: 100%; padding: 6px 10px; border: 2px solid var(--border); border-radius: 6px; background: #fff; cursor: text;"></td>`;
            
            // Debug: —ç—Ö–Ω–∏–π –º”©—Ä”©–Ω–¥ input field render —Ö–∏–π–≥–¥—ç–∂ –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö
            if (rowIdx === 0) {
              console.log("Input field render —Ö–∏–π–≥–¥—ç–∂ –±–∞–π–Ω–∞:", {
                header: h,
                colIdx,
                oorchloltHeaderIndex,
                dataField: h,
                value: finalValue,
                rowIndex: row.__rowIndex,
                isEditable
              });
            }
          } else {
            // –ë—É—Å–∞–¥ –±–∞–≥–∞–Ω—É—É–¥ - read-only (–∑”©–≤—Ö”©–Ω —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞)
            rowHtml += `<td style="padding: 8px 12px;">${escapedVal || ""}</td>`;
          }
        });
        
        rowHtml += '</tr>';
        return rowHtml;
      });
      
      const html = `<table>${thead}<tbody>${rows.join("")}</tbody></table>`;
      tableContainer.innerHTML = html;
      historyTableContainer.innerHTML = html;
    };

    const detectEquipmentField = (headers) => {
      const exactList = ["–¢–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –Ω—ç—Ä", "—Ç–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –Ω—ç—Ä", "–¢–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –Ω—ç—Ä:", "—Ç–æ–Ω–æ–≥–ª–æ–ª"];
      const exact = headers.find(h => exactList.includes(h));
      if (exact) return exact;
      const hit = headers.find(h => /—Ç–æ–Ω–æ–≥/i.test(h)) || headers[0];
      return hit || null;
    };

    const populateEquipmentFieldDropdown = () => {
      // –¢–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –±–∞–≥–∞–Ω–∞ dropdown —É—Å—Ç–≥–∞–≥–¥—Å–∞–Ω
    };

    const populateEquipmentDropdown = () => {
      equipmentSelect.innerHTML = `<option value="__all__">–ë“Ø–≥–¥</option>`;
      if (!sheetData.length || !equipmentField) return;
      const seen = new Set();
      sheetData
        .map(r => r[equipmentField])
        .forEach(v => {
          const val = (v ?? "").toString().trim();
          if (!val) return;
          if (seen.has(val)) return;
          seen.add(val);
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          equipmentSelect.appendChild(opt);
        });
      if (equipmentSelect.options.length === 1) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "(—É—Ç–≥–∞ –æ–ª–¥—Å–æ–Ω–≥“Ø–π)";
        equipmentSelect.appendChild(opt);
      }
    };

    const applyFilter = () => {
      if (!sheetData.length) {
        clearTable();
        summaryPill.textContent = "”®–≥”©–≥–¥”©–ª –∞–ª–≥–∞";
        if (detailContainer) detailContainer.innerHTML = "";
        return;
      }
      const sel = equipmentSelect.value;
      const filtered = sel === "__all__"
        ? sheetData
        : sheetData.filter(row => (row[equipmentField] ?? "").toString().trim() === sel);

      summaryPill.textContent = `${filtered.length} –º”©—Ä / ${sheetData.length} –Ω–∏–π—Ç | –¢–∞–ª–±–∞—Ä: ${equipmentField || "—Ç–∞–Ω–∏–≥–¥–∞–∞–≥“Ø–π"}`;
      renderTable(filtered);
      renderDetail(filtered);
    };

    const renderDetail = (filtered) => {
      if (!detailContainer) return; // "–°–æ–Ω–≥–æ—Å–æ–Ω —Ç–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π" —Ö—ç—Å—ç–≥ —É—Å—Ç–≥–∞–≥–¥—Å–∞–Ω
      if (!filtered?.length) {
        if (detailContainer) detailContainer.innerHTML = "";
        return;
      }
      // –ù—ç–≥–¥“Ø–≥—ç—ç—Ä –º”©—Ä”©”©—Ä –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π “Ø–∑“Ø“Ø–ª–Ω—ç
      const row = filtered[0];
      const displayHeaders = viewHeaders?.length ? viewHeaders : headers;
      
      // –¢–æ–¥–æ—Ä—Ö–æ–π —Ç–∞–ª–±–∞—Ä—É—É–¥—ã–≥ —ç—Ö–ª—ç—ç–¥ —Ö–∞—Ä—É—É–ª–∞—Ö: –î/–¥, –¢–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –Ω—ç—Ä, –•–∞–º–≥–∞–∞–ª–∞–ª—Ç—ã–Ω —Ç”©—Ä”©–ª, –ü–∞—Ä–∞–º–µ—Ç—Ä, –¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞
      const priorityHeaders = [
        { keywords: ["–¥/–¥", "–¥\\/–¥"], name: "–î/–¥" },
        { keywords: ["—Ç–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –Ω—ç—Ä", "—Ç–æ–Ω–æ–≥–ª–æ–ª"], name: "–¢–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –Ω—ç—Ä" },
        { keywords: ["—Ö–∞–º–≥–∞–∞–ª–∞–ª—Ç—ã–Ω —Ç”©—Ä”©–ª", "—Ö–∞–º–≥–∞–∞–ª–∞–ª—Ç"], name: "–•–∞–º–≥–∞–∞–ª–∞–ª—Ç—ã–Ω —Ç”©—Ä”©–ª" },
        { keywords: ["–ø–∞—Ä–∞–º–µ—Ç—Ä"], name: "–ü–∞—Ä–∞–º–µ—Ç—Ä" },
        { keywords: ["—Ç–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞", "—Ç–∞–≤–∏–ª"], name: "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" }
      ];
      const priorityFields = [];
      const otherFields = [];
      
      displayHeaders.forEach(h => {
        const headerStr = (h || "").toString().trim().toLowerCase();
        let isPriority = false;
        let priorityName = null;
        
        for (const ph of priorityHeaders) {
          const matches = ph.keywords.some(keyword => {
            const regex = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
            return regex.test(headerStr);
          });
          
          if (matches) {
            isPriority = true;
            priorityName = ph.name;
            break;
          }
        }
        
        if (isPriority) {
          priorityFields.push({ header: h, priorityName });
        } else {
          otherFields.push(h);
        }
      });
      
      // Priority fields-–∏–π–≥ –¥–∞—Ä–∞–∞–ª–ª–∞–∞—Ä —ç—Ä—ç–º–±—ç–ª—ç—Ö
      priorityFields.sort((a, b) => {
        const aIndex = priorityHeaders.findIndex(ph => ph.name === a.priorityName);
        const bIndex = priorityHeaders.findIndex(ph => ph.name === b.priorityName);
        return aIndex - bIndex;
      });
      
      // –≠—Ö–ª—ç—ç–¥ priority fields, –¥–∞—Ä–∞–∞ –Ω—å –±—É—Å–∞–¥ fields
      const orderedHeaders = [
        ...priorityFields.map(pf => pf.header),
        ...otherFields
      ];
      
      const html = orderedHeaders.map(h => {
        const val = (row[h] ?? "").toString();
        const display = val.trim() ? val : `<span class="detail-empty">–•–û–û–°–û–ù</span>`;
        return `<div class="label">${h}</div><div class="value">${display}</div>`;
      }).join("");
      detailContainer.innerHTML = html;
    };


    const loadSheet = (sheetName) => {
      if (!workbook || !sheetName) {
        console.error("Workbook —ç—Å–≤—ç–ª sheetName –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞", { workbook, sheetName });
        return;
      }
      
      try {
        const worksheet = workbook.Sheets[sheetName];
        if (!worksheet) {
          console.error("Worksheet –æ–ª–¥—Å–æ–Ω–≥“Ø–π:", sheetName);
          showError(`Sheet "${sheetName}" –æ–ª–¥—Å–æ–Ω–≥“Ø–π.`);
          return;
        }
        
        // Read as rows to avoid __EMPTY headers and pick the best header row
        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
        
        if (!rows.length) {
          console.warn("Sheet —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞");
          sheetData = [];
          headers = [];
          populateEquipmentFieldDropdown();
          populateEquipmentDropdown();
          applyFilter();
          setStatus("Sheet —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.");
          return;
        }

        const scoreRow = (row, idx) => {
          const nonEmpty = row.filter(c => (c ?? "").toString().trim() !== "").length;
          
          // –•–æ–æ—Å–æ–Ω –º”©—Ä–∏–π–≥ header –≥—ç–∂ —Ç–æ–æ—Ü–æ—Ö–≥“Ø–π
          if (nonEmpty === 0) {
            return -5000;
          }
          
          // Header –º”©—Ä–∏–π–Ω —Ç—ç–º–¥—ç–≥–ª—ç–≥—ç—ç - —è–≥ —Ç–∞–∞—Ä—á –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö (–∏–ª“Ø“Ø —É—è–Ω —Ö–∞—Ç–∞–Ω)
          const hasTonog = row.some(c => {
            const val = String(c).trim().toLowerCase();
            return /—Ç–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –Ω—ç—Ä/i.test(val) || /—Ç–æ–Ω–æ–≥–ª–æ–ª/i.test(val);
          });
          const hasDd = row.some(c => {
            const val = String(c).trim();
            return /^–¥\/–¥$/i.test(val) || val === "–î/–¥" || /^–¥\/–¥$/i.test(val);
          });
          const hasHamgaalalt = row.some(c => {
            const val = String(c).trim().toLowerCase();
            return /—Ö–∞–º–≥–∞–∞–ª–∞–ª—Ç—ã–Ω —Ç”©—Ä”©–ª/i.test(val) || /—Ö–∞–º–≥–∞–∞–ª–∞–ª—Ç/i.test(val);
          });
          const hasParametr = row.some(c => {
            const val = String(c).trim().toLowerCase();
            return /^–ø–∞—Ä–∞–º–µ—Ç—Ä$/i.test(val) || /–ø–∞—Ä–∞–º–µ—Ç—Ä/i.test(val);
          });
          const hasTavlynUtga = row.some(c => {
            const val = String(c).trim().toLowerCase();
            return /—Ç–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞/i.test(val) || /—Ç–∞–≤–∏–ª/i.test(val);
          });
          const hasOorchlolt = row.some(c => {
            const val = String(c).trim().toLowerCase();
            return /”©”©—Ä—á–ª”©–ª—Ç/i.test(val);
          });
          
          // Header –º”©—Ä–∏–π–Ω –æ–Ω–æ–æ - –æ–ª–æ–Ω header —Ç—ç–º–¥—ç–≥–ª—ç–≥—ç—ç –±–∞–π—Ö –Ω—å —á—É—Ö–∞–ª
          let score = nonEmpty * 2; // –û–ª–æ–Ω –±–∞–≥–∞–Ω–∞–¥ —É—Ç–≥–∞ –±–∞–π—Ö –Ω—å header –º”©—Ä–∏–π–Ω —à–∏–Ω–∂
          if (hasTonog) score += 25;
          if (hasDd) score += 20;
          if (hasHamgaalalt) score += 20;
          if (hasParametr) score += 18;
          if (hasTavlynUtga) score += 18;
          if (hasOorchlolt) score += 15;
          
          // –•—ç—Ä—ç–≤ 3-—ç—ç—Å –æ–ª–æ–Ω header —Ç—ç–º–¥—ç–≥–ª—ç–≥—ç—ç –±–∞–π–≤–∞–ª —ç–Ω—ç –Ω—å header –º”©—Ä –±–∞–π—Ö –º–∞–≥–∞–¥–ª–∞–ª—Ç–∞–π
          const headerCount = [hasTonog, hasDd, hasHamgaalalt, hasParametr, hasTavlynUtga, hasOorchlolt].filter(Boolean).length;
          if (headerCount >= 3) {
            score += 50; // 3-–∞–∞—Å –æ–ª–æ–Ω header —Ç—ç–º–¥—ç–≥–ª—ç–≥—ç—ç –±–∞–π–≤–∞–ª —ç–Ω—ç –Ω—å header –º”©—Ä –±–∞–π—Ö –º–∞–≥–∞–¥–ª–∞–ª—Ç–∞–π
          }
          
          // Header –º”©—Ä –Ω—å –∏—Ö—ç–≤—á–ª—ç–Ω 1-—Ä –º”©—Ä —ç—Å–≤—ç–ª 3-—Ä –º”©—Ä”©–Ω–¥ –±–∞–π–¥–∞–≥
          const positionBonus = (idx === 0 && headerCount >= 3) ? 30 : // 1-—Ä –º”©—Ä”©–Ω–¥ header keywords –±–∞–π–≤–∞–ª –∏–ª“Ø“Ø ”©–Ω–¥”©—Ä –æ–Ω–æ–æ
                                (idx === 2) ? 20 : 
                                (idx >= 1 && idx < 10) ? 10 : 
                                (idx >= 0 && idx < 10) ? 3 : 0;
          
          return score + positionBonus;
        };

        // Header –º”©—Ä–∏–π–≥ –æ–ª–æ—Ö - 1-—Ä –º”©—Ä–∏–π–≥ —à—É—É–¥ header –º”©—Ä –≥—ç–∂ –∞—à–∏–≥–ª–∞—Ö
        let headerIdx = 0; // –ó”©–≤—Ö”©–Ω 1-—Ä –º”©—Ä–∏–π–≥ header –º”©—Ä –≥—ç–∂ –∞—à–∏–≥–ª–∞—Ö
        let bestScore = 100; // Score —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π, —à—É—É–¥ 1-—Ä –º”©—Ä
        
        console.log(`1-—Ä –º”©—Ä–∏–π–≥ header –º”©—Ä –≥—ç–∂ —Å–æ–Ω–≥–æ–ª–æ–æ (headerIdx=${headerIdx})`);
        console.log("Header –º”©—Ä–∏–π–Ω —É—Ç–≥—É—É–¥:", rows[headerIdx]);
        

        console.log(`Header –º”©—Ä –æ–ª–¥–ª–æ–æ: –º”©—Ä ${headerIdx + 1}, –æ–Ω–æ–æ: ${bestScore}`);
        console.log("Header –º”©—Ä–∏–π–Ω —É—Ç–≥—É—É–¥:", rows[headerIdx]);
        console.log("Header –º”©—Ä–∏–π–Ω —É—Ç–≥—É—É–¥ (–¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π):", rows[headerIdx].map((c, i) => `[${i}]: "${(c ?? "").toString().trim()}"`));
        
        // Google Sheets –¥—ç—ç—Ä—Ö header –º”©—Ä–∏–π–Ω –¥—É–≥–∞–∞—Ä—ã–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö (1-based)
        headerRowIndex = headerIdx + 1;
        console.log(`Header –º”©—Ä Google Sheets –¥—ç—ç—Ä: row ${headerRowIndex}`);

        const rawHeaders = rows[headerIdx].map((c, i) => {
          const name = (c ?? "").toString().trim();
          return name || `–ö–æ–ª–æ–Ω-${i + 1}`;
        });

        headers = rawHeaders;
        console.log("Headers –æ–ª–¥–ª–æ–æ:", headers);
        console.log("Headers (–¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π):", headers.map((h, i) => `[${i}]: "${h}"`));
        
        // Header –º”©—Ä–∏–π–Ω –∑”©–≤ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö
        const expectedHeaders = ["–î/–¥", "–¢–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –Ω—ç—Ä", "–•–∞–º–≥–∞–∞–ª–∞–ª—Ç—ã–Ω —Ç”©—Ä”©–ª", "–ø–∞—Ä–∞–º–µ—Ç—Ä", "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞", "”©”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥"];
        const foundHeaders = expectedHeaders.map(eh => {
          const idx = headers.findIndex(h => h.toLowerCase().includes(eh.toLowerCase()) || eh.toLowerCase().includes(h.toLowerCase()));
          return { expected: eh, found: idx >= 0 ? headers[idx] : null, index: idx };
        });
        console.log("Header –º”©—Ä–∏–π–Ω –∑”©–≤ —ç—Å—ç—Ö —à–∞–ª–≥–∞–ª—Ç:", foundHeaders);

        // Body –º”©—Ä“Ø“Ø–¥–∏–π–≥ –æ–ª–æ—Ö - header –º”©—Ä–∏–π–Ω –¥–∞—Ä–∞–∞—Ö–∏–π–Ω –±“Ø—Ö –º”©—Ä“Ø“Ø–¥
        const bodyRows = rows.slice(headerIdx + 1);
        console.log(`Body rows (–±“Ø—Ö): ${bodyRows.length} –º”©—Ä (header –º”©—Ä: ${headerIdx + 1}, –Ω–∏–π—Ç –º”©—Ä: ${rows.length})`);
        if (bodyRows.length > 0) {
          console.log("–≠—Ö–Ω–∏–π 5 body –º”©—Ä:", bodyRows.slice(0, 5).map(r => r.slice(0, 6).map(c => (c ?? "").toString().trim().substring(0, 15))));
          // –≠—Ö–Ω–∏–π body –º”©—Ä–∏–π–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª
          console.log("–≠—Ö–Ω–∏–π body –º”©—Ä (–¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π):", bodyRows[0].map((c, i) => `[${i}]: "${(c ?? "").toString().trim()}" (header: "${headers[i] || 'N/A'}")`));
        } else {
          console.warn("Body –º”©—Ä –æ–ª–¥—Å–æ–Ω–≥“Ø–π! Header –º”©—Ä–∏–π–Ω –¥–∞—Ä–∞–∞ –º”©—Ä –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.");
        }
        
        // Footer –º”©—Ä“Ø“Ø–¥–∏–π–≥ –æ–ª–æ—Ö (–¢–∞–≤–∏–ª —Ç–∞–≤—å—Å–∞–Ω, –ê–ª–±–∞—Ç —Ç–æ–æ—Ç—ã–Ω –¥—É–≥–∞–∞—Ä –≥—ç—Ö –º—ç—Ç)
        const footerKeywords = ["—Ç–∞–≤–∏–ª —Ç–∞–≤—å—Å–∞–Ω", "–∞–ª–±–∞—Ç —Ç–æ–æ—Ç—ã–Ω", "–ø—Ä–æ—Ç–æ–∫–æ–ª—ã–Ω –¥—É–≥–∞–∞—Ä", "–æ–Ω —Å–∞—Ä ”©–¥”©—Ä", "–∏–Ω–∂–µ–Ω–µ—Ä"];
        const footerRows = [];
        const dataRows = [];
        
        bodyRows.forEach((r, idx) => {
          const rowText = r.map(c => (c ?? "").toString().trim().toLowerCase()).join(" ");
          const isFooter = footerKeywords.some(keyword => rowText.includes(keyword));
          
          const hasData = r.some(c => {
            const val = (c ?? "").toString().trim();
            return val && val.length > 0;
          });
          
          if (isFooter) {
            footerRows.push({ row: r, originalIdx: headerIdx + 1 + idx + 1 });
            // Footer –º”©—Ä“Ø“Ø–¥–∏–π–≥ –º”©–Ω dataRows-–¥ –Ω—ç–º—ç—Ö (—Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ —Ö–∞—Ä—É—É–ª–∞—Ö)
            if (hasData) {
              dataRows.push(r);
            }
          } else {
            if (hasData) {
              dataRows.push(r);
            }
          }
        });
        
        console.log(`Data rows: ${dataRows.length} –º”©—Ä (bodyRows: ${bodyRows.length})`);
        console.log(`Footer rows: ${footerRows.length} –º”©—Ä`);
        if (dataRows.length === 0 && bodyRows.length > 0) {
          console.warn("Data rows –æ–ª–¥—Å–æ–Ω–≥“Ø–π! Body –º”©—Ä“Ø“Ø–¥ –±–∞–π–≥–∞–∞ –±–æ–ª–æ–≤—á –±“Ø—Ö –º”©—Ä —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞.");
          console.log("–≠—Ö–Ω–∏–π body –º”©—Ä–∏–π–Ω —É—Ç–≥—É—É–¥:", bodyRows[0]?.slice(0, 6).map(c => (c ?? "").toString().trim()));
        }
        if (footerRows.length > 0) {
          console.log("Footer –º”©—Ä“Ø“Ø–¥:", footerRows.map(fr => fr.row.slice(0, 3).map(c => (c ?? "").toString().trim())));
        }
        
        // Footer –º”©—Ä“Ø“Ø–¥–∏–π–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö
        footerData = footerRows.map(fr => {
          // Footer –º”©—Ä“Ø“Ø–¥ –Ω—å –∏—Ö—ç–≤—á–ª—ç–Ω 2 –±–∞–≥–∞–Ω–∞: —Ç–∞–π–ª–±–∞—Ä (B-F merged) –±–æ–ª–æ–Ω —É—Ç–≥–∞ (G)
          // B –±–∞–≥–∞–Ω–∞ (index 1) -—ç—ç—Å F –±–∞–≥–∞–Ω–∞ (index 5) —Ö“Ø—Ä—Ç—ç–ª merged, G –±–∞–≥–∞–Ω–∞ (index 6) —É—Ç–≥–∞
          let label = "";
          let value = "";
          
          // –≠—Ö–ª—ç—ç–¥ B –±–∞–≥–∞–Ω–∞–∞—Å (index 1) —Ö–∞–π—Ö
          for (let i = 1; i < Math.min(6, fr.row.length); i++) {
            const cellVal = (fr.row[i] ?? "").toString().trim();
            if (cellVal) {
              label = cellVal;
              break;
            }
          }
          
          // –•—ç—Ä—ç–≤ B –±–∞–≥–∞–Ω–∞ —Ö–æ–æ—Å–æ–Ω –±–æ–ª A –±–∞–≥–∞–Ω–∞–∞—Å —Ö–∞–π—Ö
          if (!label && fr.row[0]) {
            label = fr.row[0].toString().trim();
          }
          
          // G –±–∞–≥–∞–Ω–∞ (index 6) —ç—Å–≤—ç–ª H –±–∞–≥–∞–Ω–∞ (index 7) —É—Ç–≥–∞
          value = (fr.row[6] ?? fr.row[7] ?? "").toString().trim();
          
          return { label, value, originalRow: fr.originalIdx };
        });
        
        sheetData = dataRows.map((row, idx) => {
          const obj = {};
          headers.forEach((h, colIdx) => { 
            // Row array-–∏–π–Ω —É—Ä—Ç header-–∏–π–Ω —É—Ä—Ç–∞–∞—Å –±–∞–≥–∞ –±–∞–π–∂ –±–æ–ª–Ω–æ
            const val = row[colIdx] !== undefined ? row[colIdx] : "";
            const valStr = (val ?? "").toString();
            obj[h] = valStr;
            
            // Debug: "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—É—É–¥—ã–≥ —Ö—ç–≤–ª—ç—Ö
            if (/—Ç–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞/i.test(h) && idx < 3 && valStr) {
              console.log(`Row ${idx}, Column ${colIdx} (${h}): "${valStr}" (original: ${val})`);
            }
          });
          obj.__rowIndex = idx;
          return obj;
        });
        
        // Debug: –≠—Ö–Ω–∏–π –º”©—Ä–∏–π–Ω –±“Ø—Ö —É—Ç–≥—É—É–¥—ã–≥ —Ö—ç–≤–ª—ç—Ö
        if (sheetData.length > 0) {
          console.log("–≠—Ö–Ω–∏–π –º”©—Ä–∏–π–Ω –±“Ø—Ö —É—Ç–≥—É—É–¥:", sheetData[0]);
          console.log("–≠—Ö–Ω–∏–π –º”©—Ä–∏–π–Ω row array:", dataRows[0]);
          // –≠—Ö–Ω–∏–π –º”©—Ä–∏–π–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª
          console.log("–≠—Ö–Ω–∏–π –º”©—Ä–∏–π–Ω –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª:", Object.keys(sheetData[0]).map(key => `${key}: "${sheetData[0][key]}"`));
        }

        console.log(`Sheet data: ${sheetData.length} –º”©—Ä —É–Ω—à–ª–∞–∞`);
        if (sheetData.length > 0) {
          console.log("–≠—Ö–Ω–∏–π sheet data –º”©—Ä:", sheetData[0]);
          // "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—É—É–¥—ã–≥ —à–∞–ª–≥–∞—Ö
          const tavlynUtgaHeader = headers.find(h => /—Ç–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞/i.test(h));
          if (tavlynUtgaHeader) {
            console.log("–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞ –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—É—É–¥ (—ç—Ö–Ω–∏–π 5):", sheetData.slice(0, 5).map(r => r[tavlynUtgaHeader]));
          }
        }

        if (sheetData.length === 0) {
          const headerPreview = rows[headerIdx]?.slice(0, 6).map(c => (c ?? "").toString().trim()).join(", ") || "–•–æ–æ—Å–æ–Ω";
          const firstBodyRowPreview = bodyRows[0]?.slice(0, 6).map(c => (c ?? "").toString().trim()).join(", ") || "–•–æ–æ—Å–æ–Ω";
          const errorMsg = `Sheet-–¥ ”©–≥”©–≥–¥”©–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\n\nHeader –º”©—Ä: ${headerIdx + 1} (${headerPreview})\nBody –º”©—Ä“Ø“Ø–¥: ${bodyRows.length}\nData –º”©—Ä“Ø“Ø–¥: ${dataRows.length}\n\n–≠—Ö–Ω–∏–π body –º”©—Ä: ${firstBodyRowPreview}\n\n–ó”©–≤–ª”©–º–∂:\n1. Google Sheets-–¥ header –º”©—Ä –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö\n2. Header –º”©—Ä–∏–π–Ω –¥–æ–æ—à ”©–≥”©–≥–¥”©–ª –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö\n3. Console-–æ–æ—Å –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª —Ö–∞—Ä–∞—Ö`;
          console.error("Sheet-–¥ ”©–≥”©–≥–¥”©–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π!", {
            headerIdx: headerIdx + 1,
            headerRow: rows[headerIdx],
            bodyRowsCount: bodyRows.length,
            dataRowsCount: dataRows.length,
            firstBodyRow: bodyRows[0],
            allRows: rows.length
          });
          setStatus(errorMsg);
          showError(errorMsg);
        }

        // Default equipment field: second column if exists; else detected; else first
        equipmentField = headers[1] || detectEquipmentField(headers) || headers[0] || null;
        console.log("Equipment field:", equipmentField);

        // Fill-down for merged-like blanks in columns that should be merged
        // –≠—Ö–Ω–∏–π –±–∞–≥–∞–Ω–∞ (–î/–¥), —Ç–æ–Ω–æ–≥–ª–æ–ª—ã–Ω –Ω—ç—Ä, —Ö–∞–º–≥–∞–∞–ª–∞–ª—Ç—ã–Ω —Ç”©—Ä”©–ª –±–∞–≥–∞–Ω—É—É–¥–∞–¥ fill-down —Ö–∏–π—Ö
        const firstColName = headers[0] || "";
        const protectionTypeColName = headers.find(h => /—Ö–∞–º–≥–∞–∞–ª–∞–ª—Ç—ã–Ω —Ç”©—Ä”©–ª/i.test(h) || h.includes('–•–∞–º–≥–∞–∞–ª–∞–ª—Ç—ã–Ω —Ç”©—Ä”©–ª')) || "";
        
        // Fill-down for equipment field
        if (equipmentField) {
          let last = "";
          sheetData.forEach(row => {
            const val = (row[equipmentField] ?? "").toString().trim();
            if (val) last = val;
            else row[equipmentField] = last;
          });
        }
        
        // Fill-down for first column (–î/–¥)
        if (firstColName) {
          let last = "";
          sheetData.forEach(row => {
            const val = (row[firstColName] ?? "").toString().trim();
            if (val) last = val;
            else if (last) row[firstColName] = last;
          });
        }
        
        // Fill-down for protection type column
        if (protectionTypeColName) {
          let last = "";
          sheetData.forEach(row => {
            const val = (row[protectionTypeColName] ?? "").toString().trim();
            if (val) last = val;
            else if (last) row[protectionTypeColName] = last;
          });
        }
        

        populateEquipmentFieldDropdown();
        populateEquipmentDropdown();
        viewHeaders = [...headers];
        applyFilter();
        
        if (sheetData.length > 0) {
          setStatus(`–ê–º–∂–∏–ª—Ç—Ç–∞–π: ${sheetData.length} –º”©—Ä —É–Ω—à–ª–∞–∞`);
        }
      } catch (err) {
        console.error("loadSheet –∞–ª–¥–∞–∞:", err);
        showError(`Sheet —É–Ω—à–∏—Ö –∞–ª–¥–∞–∞: ${err.message}`);
      }
    };

    const populateSheetDropdown = () => {
      sheetSelect.innerHTML = "";
      if (!workbook?.SheetNames?.length) return;
      workbook.SheetNames.forEach((name, idx) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        if (idx === 0) opt.selected = true;
        sheetSelect.appendChild(opt);
      });
      loadSheet(sheetSelect.value);
    };

    sheetSelect.addEventListener("change", () => loadSheet(sheetSelect.value));
    equipmentSelect.addEventListener("change", applyFilter);

    // –•“Ø—Å–Ω—ç–≥—Ç—ç–¥ –∑–∞—Å–≤–∞—Ä —Ö–∏–π—Ö event listener
    const handleTableInput = (e) => {
      const t = e.target;
      if (t.tagName !== "INPUT") return;
      const rowIdx = Number(t.dataset.row);
      const field = t.dataset.field;
      if (Number.isNaN(rowIdx) || !field) return;
      const row = sheetData.find(r => r.__rowIndex === rowIdx);
      if (!row) return;
      row[field] = t.value;
      
      // –î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª–ª–∏–π–≥ —à–∏–Ω—ç—á–ª—ç—Ö
      const filtered = equipmentSelect.value === "__all__"
        ? sheetData
        : sheetData.filter(r => (r[equipmentField] ?? "").toString().trim() === equipmentSelect.value);
      if (filtered.length > 0 && filtered[0].__rowIndex === rowIdx) {
        renderDetail([row]);
      }
    };
    
    historyTableContainer.addEventListener("input", handleTableInput);
    tableContainer.addEventListener("input", handleTableInput);

    downloadBtn.addEventListener("click", async () => {
      if (!workbook) {
        showError("–≠—Ö–ª—ç—ç–¥ Excel —Ñ–∞–π–ª —É–Ω—à—É—É–ª–∞–∞—Ä–∞–π.");
        return;
      }
      if (!sheetSelect.value) {
        showError("Sheet —Å–æ–Ω–≥–æ–≥–¥–æ–æ–≥“Ø–π –±–∞–π–Ω–∞.");
        return;
      }
      const cleanRows = sheetData.map(r => {
        const obj = {};
        headers.forEach(h => { obj[h] = r[h]; });
        return obj;
      });
      const newSheet = XLSX.utils.json_to_sheet(cleanRows, { header: headers, skipHeader: false });
      workbook.Sheets[sheetSelect.value] = newSheet;
      
      // Excel —Ñ–∞–π–ª —Ç–∞—Ç–∞—Ö
      if (window.showSaveFilePicker) {
        // fileHandle –±–∞–π—Ö–≥“Ø–π –±–æ–ª —à–∏–Ω—ç —Ñ–∞–π–ª “Ø“Ø—Å–≥—ç—Ö —ç—Å–≤—ç–ª –±–∞–π—Ä—à–ª—ã–≥ —Å–æ–Ω–≥–æ—Ö
        try {
          const saveHandle = await window.showSaveFilePicker({
            suggestedName: originalFileName || "updated.xlsx",
            types: [{
              description: "Excel —Ñ–∞–π–ª",
              accept: { "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": [".xlsx"] }
            }]
          });
          const wbout = XLSX.write(workbook, { type: "array", bookType: "xlsx" });
          const writable = await saveHandle.createWritable();
          await writable.write(new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }));
          await writable.close();
          setStatus(`–ê–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞: ${saveHandle.name}`);
        } catch (err) {
          if (err.name !== "AbortError") {
            console.error("–•–∞–¥–≥–∞–ª–∞—Ö –∞–ª–¥–∞–∞:", err);
            // Fallback: —ç–Ω–≥–∏–π–Ω —Ç–∞—Ç–∞—Ö
            const fileName = originalFileName || "updated.xlsx";
            XLSX.writeFile(workbook, fileName);
            setStatus(`–¢–∞—Ç–∞–≥–¥–ª–∞–∞: ${fileName}`);
          }
        }
      } else {
        // Fallback: —ç–Ω–≥–∏–π–Ω —Ç–∞—Ç–∞—Ö
        const fileName = originalFileName || "updated.xlsx";
        XLSX.writeFile(workbook, fileName);
        setStatus(`–¢–∞—Ç–∞–≥–¥–ª–∞–∞: ${fileName} (—Ç–∞—Ç–∞–∂ –∞–≤—Å–Ω—ã –¥–∞—Ä–∞–∞ –∞–Ω—Ö–Ω—ã —Ñ–∞–π–ª—ã–≥ –æ—Ä–ª—É—É–ª–Ω–∞ —É—É)`);
      }
    });

    // Google Sheets –¥—ç—ç—Ä —Ö–∞–¥–≥–∞–ª–∞—Ö
    saveToGoogleSheetsBtn.addEventListener("click", async () => {
      if (!googleSheetId) {
        showError("–≠—Ö–ª—ç—ç–¥ Google Sheets —É–Ω—à—É—É–ª–∞–∞—Ä–∞–π.");
        return;
      }
      if (!sheetSelect.value) {
        showError("Sheet —Å–æ–Ω–≥–æ–≥–¥–æ–æ–≥“Ø–π –±–∞–π–Ω–∞.");
        return;
      }

      try {
        // File:// protocol-–∏–π–≥ —à–∞–ª–≥–∞—Ö
        if (window.location.protocol === 'file:') {
          showError(`–§–∞–π–ª—ã–≥ —à—É—É–¥ –Ω—ç—ç–∂ –±–∞–π–Ω–∞ (file://). Google OAuth 2.0 –∞–∂–∏–ª–ª–∞—Ö–≥“Ø–π.\n\n–ó”©–≤–ª”©–º–∂:\n1. Localhost –¥—ç—ç—Ä –∞–∂–∏–ª–ª—É—É–ª–∞—Ö:\n   - Terminal/Command Prompt –Ω—ç—ç—Ö\n   - –≠–Ω—ç folder —Ä—É—É –æ—Ä–æ—Ö\n   - "python -m http.server 8000" —ç—Å–≤—ç–ª "npx http-server" –≥—ç–∂ –±–∏—á–∏—Ö\n   - Browser –¥—ç—ç—Ä "http://localhost:8000" –Ω—ç—ç—Ö\n\n2. –≠—Å–≤—ç–ª VS Code Live Server extension –∞—à–∏–≥–ª–∞—Ö`);
          return;
        }

        setStatus("Google Sheets –¥—ç—ç—Ä —Ö–∞–¥–≥–∞–ª–∞–∂ –±–∞–π–Ω–∞...");

        // Google API-–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö
        if (!window.gapi) {
          throw new Error("Google API library –∞—á–∞–∞–ª–∞–≥–¥–∞–∞–≥“Ø–π –±–∞–π–Ω–∞. –ò–Ω—Ç–µ—Ä–Ω—ç—Ç —Ö–æ–ª–±–æ–ª—Ç —à–∞–ª–≥–∞–∞—Ä–∞–π.");
        }

        await new Promise((resolve, reject) => {
          window.gapi.load('client', () => {
            window.gapi.client.init({
              discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
            }).then(() => {
              resolve();
            }).catch(reject);
          });
        });

        // Localhost –¥—ç—ç—Ä –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö
        const isLocalhost = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1' ||
                           window.location.hostname === '';
        const currentOrigin = window.location.origin;
        
        console.log("Current origin:", currentOrigin);
        console.log("Is localhost:", isLocalhost);
        
        if (isLocalhost) {
          setStatus(`Localhost –¥—ç—ç—Ä –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–Ω–∞: ${currentOrigin}\nGoogle Cloud Console –¥—ç—ç—Ä "http://localhost" —ç—Å–≤—ç–ª "http://127.0.0.1" –Ω—ç–º—ç—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π.`);
        }

        // OAuth 2.0 token –∞–≤–∞—Ö
        const clientId = googleApiKeyInput.value.trim();
        if (!clientId) {
          showError("OAuth 2.0 Client ID –æ—Ä—É—É–ª–Ω–∞ —É—É.");
          return;
        }

        // OAuth token —à–∞–ª–≥–∞—Ö - —Ö—ç—Ä—ç–≤ –±–∞–π–≥–∞–∞ –±–æ–ª –¥–∞—Ö–∏–Ω –Ω—ç–≤—Ç—Ä—ç—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π
        const currentToken = window.gapi.client.getToken();
        if (!currentToken || !currentToken.access_token) {
          // Token –±–∞–π—Ö–≥“Ø–π –±–æ–ª –ª OAuth flow —ç—Ö–ª“Ø“Ø–ª—ç—Ö
          setStatus("Google account-–∞–∞—Ä –Ω—ç–≤—Ç—Ä—ç—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π...");
        }
        
        // –•–∞–¥–≥–∞–ª–∞—Ö –ª–æ–≥–∏–∫–∏–π–≥ —Ñ—É–Ω–∫—Ü –±–æ–ª–≥–æ–Ω –≥–∞—Ä–≥–∞—Ö (token –±–∞–π–≥–∞–∞ —ç—Å–≤—ç–ª —à–∏–Ω—ç—ç—Ä –∞–≤—Å–∞–Ω “Ø–µ–¥ –∞—à–∏–≥–ª–∞—Ö)
        const performSave = async () => {
            try {
            // ”®”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥ –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—É—É–¥—ã–≥ –æ–ª–æ—Ö
            // –ë“Ø—Ö —Ö—É–≤–∏–ª–±–∞—Ä—É—É–¥—ã–≥ —à–∞–ª–≥–∞—Ö: "”©”©—Ä—á–ª”©–ª—Ç", "”©”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥", "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –≥—ç—Ö –º—ç—Ç
            console.log("Headers —à–∞–ª–≥–∞–ª—Ç (—Ö–∞–¥–≥–∞–ª–∞—Ö):", {
              headers,
              headersDetailed: headers.map((h, i) => ({ 
                index: i, 
                name: h, 
                testOorchlolt: /”©”©—Ä—á–ª”©–ª—Ç/i.test(h || ""),
                testTavilOruulah: /—Ç–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö/i.test(h || "")
              }))
            });
            
            // –≠—Ö–ª—ç—ç–¥ "”©”©—Ä—á–ª”©–ª—Ç" –≥—ç—Å—ç–Ω header-–∏–π–≥ –æ–ª–æ—Ö
            let oorchloltColIndex = headers.findIndex(h => {
              const headerStr = (h || "").toString().trim();
              return /”©”©—Ä—á–ª”©–ª—Ç/i.test(headerStr);
            });
            
            // –•—ç—Ä—ç–≤ –æ–ª–¥–æ—Ö–≥“Ø–π –±–æ–ª "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –≥—ç—Å—ç–Ω header-–∏–π–≥ –æ–ª–æ—Ö
            if (oorchloltColIndex < 0) {
              oorchloltColIndex = headers.findIndex(h => {
                const headerStr = (h || "").toString().trim();
                return /—Ç–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö/i.test(headerStr);
              });
              if (oorchloltColIndex >= 0) {
                console.log("'–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö' –±–∞–≥–∞–Ω–∞ –æ–ª–¥–ª–æ–æ (headers-–¥):", {
                  index: oorchloltColIndex,
                  header: headers[oorchloltColIndex]
                });
              }
            }
            
            // –•—ç—Ä—ç–≤ headers-–¥ –æ–ª–¥–æ—Ö–≥“Ø–π –±–æ–ª, viewHeaders-—ç—ç—Å –æ–ª–æ—Ö
            let finalOorchloltColIndex = oorchloltColIndex;
            
            if (oorchloltColIndex < 0) {
              // Fallback: viewHeaders-—ç—ç—Å –æ–ª–æ—Ö
              let viewOorchloltColIndex = viewHeaders.findIndex(h => {
                const headerStr = (h || "").toString().trim();
                return /”©”©—Ä—á–ª”©–ª—Ç/i.test(headerStr);
              });
              
              // –•—ç—Ä—ç–≤ –æ–ª–¥–æ—Ö–≥“Ø–π –±–æ–ª "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –≥—ç—Å—ç–Ω header-–∏–π–≥ –æ–ª–æ—Ö
              if (viewOorchloltColIndex < 0) {
                viewOorchloltColIndex = viewHeaders.findIndex(h => {
                  const headerStr = (h || "").toString().trim();
                  return /—Ç–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö/i.test(headerStr);
                });
                if (viewOorchloltColIndex >= 0) {
                  console.log("'–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö' –±–∞–≥–∞–Ω–∞ –æ–ª–¥–ª–æ–æ (viewHeaders-–¥):", {
                    index: viewOorchloltColIndex,
                    header: viewHeaders[viewOorchloltColIndex]
                  });
                }
              }
              
              if (viewOorchloltColIndex >= 0) {
                const viewHeaderName = viewHeaders[viewOorchloltColIndex];
                console.warn("Headers-–¥ '”©”©—Ä—á–ª”©–ª—Ç'/'–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö' –æ–ª–¥—Å–æ–Ω–≥“Ø–π, viewHeaders-—ç—ç—Å –æ–ª–¥–ª–æ–æ:", {
                  viewHeaders,
                  viewOorchloltColIndex,
                  viewHeader: viewHeaderName
                });
                
                // headers-–¥ —ç–Ω—ç header name-–∏–π–≥ –æ–ª–æ—Ö
                const matchedHeaderIndex = headers.findIndex(h => h === viewHeaderName);
                if (matchedHeaderIndex >= 0) {
                  finalOorchloltColIndex = matchedHeaderIndex;
                  console.log("Headers-–¥ viewHeader name-—ç—ç—Ä –æ–ª–¥–ª–æ–æ:", finalOorchloltColIndex);
                } else {
                  // –•—ç—Ä—ç–≤ headers-–¥ –æ–ª–¥–æ—Ö–≥“Ø–π –±–æ–ª, viewHeaders-–∏–π–Ω index-–∏–π–≥ –∞—à–∏–≥–ª–∞—Ö
                  // (headers –±–æ–ª–æ–Ω viewHeaders –Ω—å –∏—Ö—ç–≤—á–ª—ç–Ω –∏–∂–∏–ª –±–∞–π–¥–∞–≥)
                  if (viewOorchloltColIndex < headers.length) {
                    finalOorchloltColIndex = viewOorchloltColIndex;
                    console.log("ViewHeaders-–∏–π–Ω index-–∏–π–≥ –∞—à–∏–≥–ª–∞–∂ –±–∞–π–Ω–∞:", finalOorchloltColIndex);
                  }
                }
              }
              
              if (finalOorchloltColIndex < 0) {
                // IP sheet-–∏–π–Ω —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥ "”®”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥" –±–∞–≥–∞–Ω–∞ —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π
                const selectedSheetName = sheetSelect.value || "";
                const isIPSheet = /IP/i.test(selectedSheetName);
                
                if (!isIPSheet) {
                  showError(`”®”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥/–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö –±–∞–≥–∞–Ω–∞ –æ–ª–¥—Å–æ–Ω–≥“Ø–π.\n\nHeaders: ${headers.join(", ")}\nViewHeaders: ${viewHeaders.join(", ")}\n\nConsole-–æ–æ—Å –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª —Ö–∞—Ä–∞—Ö.`);
                  return;
                } else {
                  console.log("IP sheet –±–∞–π–Ω–∞, '”®”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥' –±–∞–≥–∞–Ω–∞ —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π");
                  // IP sheet-–∏–π–Ω —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥ dummy index –∞—à–∏–≥–ª–∞—Ö (—Ö—ç—Ä—ç–≥–ª—ç—Ö–≥“Ø–π)
                  finalOorchloltColIndex = -1;
                }
              }
            }
            
            // finalOorchloltColIndex-–∏–π–≥ –∞—à–∏–≥–ª–∞—Ö
            const oorchloltColIndexToUse = finalOorchloltColIndex;
            
            // IP sheet-–∏–π–Ω —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥ "”®”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥" –±–∞–≥–∞–Ω–∞ —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π
            const selectedSheetNameCheck = sheetSelect.value || "";
            const isIPSheetCheck = /IP/i.test(selectedSheetNameCheck);
            
            if (isIPSheetCheck) {
              console.log("IP sheet –±–∞–π–Ω–∞, '”®”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥' –±–∞–≥–∞–Ω–∞ —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π");
            } else {
              console.log("”®”©—Ä—á–ª”©–ª—Ç“Ø“Ø–¥ –±–∞–≥–∞–Ω–∞ –æ–ª–¥–ª–æ–æ:", {
                index: oorchloltColIndexToUse,
                header: oorchloltColIndexToUse >= 0 ? headers[oorchloltColIndexToUse] : "–û–ª–¥—Å–æ–Ω–≥“Ø–π",
                headers,
                viewHeaders
              });
            }

            const editableInputs = document.querySelectorAll('.editable-input');
            const inputValues = new Map();
            editableInputs.forEach(input => {
              const rowIndex = parseInt(input.getAttribute('data-row'));
              const field = input.getAttribute('data-field');
              const value = input.value.trim();
              if (rowIndex !== null && field) {
                const key = `${rowIndex}_${field}`;
                inputValues.set(key, value);
              }
            });
            
            // Footer –º”©—Ä“Ø“Ø–¥–∏–π–Ω "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –±–∞–≥–∞–Ω–∞–¥ —Ö–æ–æ—Å–æ–Ω –±–∞–π–≥–∞–∞ —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥ —Ö–∞–¥–≥–∞–ª–∂ –±–æ–ª–æ—Ö—É–π—Ü –±–æ–ª–≥–æ—Ö
            // Validation-–∏–π–≥ —É—Å—Ç–≥–∞—Å–∞–Ω - —Ö–æ–æ—Å–æ–Ω –±–∞–π–≥–∞–∞ —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥ –º”©–Ω —Ö–∞–¥–≥–∞–ª–∂ –±–æ–ª–Ω–æ

            // Sheet name –æ–ª–æ—Ö - Google Sheets API-–∞–∞—Å –±–æ–¥–∏—Ç sheet name –∞–≤–∞—Ö
            // –û–¥–æ–æ–≥–∏–π–Ω —Å–æ–Ω–≥–æ—Å–æ–Ω sheet-–∏–π–Ω –Ω—ç—Ä–∏–π–≥ –∞–≤–∞—Ö
            const selectedSheetName = sheetSelect.value;
            if (!selectedSheetName) {
              showError("Sheet —Å–æ–Ω–≥–æ–≥–¥–æ–æ–≥“Ø–π –±–∞–π–Ω–∞.");
              return;
            }
            
            // Sheet name -> GID mapping-–æ–æ—Å –æ–¥–æ–æ–≥–∏–π–Ω sheet-–∏–π–Ω GID-–∏–π–≥ –æ–ª–æ—Ö
            let sheetName = selectedSheetName;
            let currentSheetGid = sheetNameToGidMap[selectedSheetName] || googleSheetGid;
            
            if (sheetNameToGidMap[selectedSheetName]) {
              console.log(`–°–æ–Ω–≥–æ—Å–æ–Ω sheet: "${selectedSheetName}" -> GID ${currentSheetGid} (mapping-–æ–æ—Å)`);
            } else {
              console.warn(`"${selectedSheetName}" sheet mapping-–¥ –æ–ª–¥—Å–æ–Ω–≥“Ø–π, default GID –∞—à–∏–≥–ª–∞–∂ –±–∞–π–Ω–∞: ${currentSheetGid}`);
              
              // Mapping-–¥ –±–∞–π—Ö–≥“Ø–π –±–æ–ª metadata-–∞–∞—Å –æ–ª–æ—Ö
              try {
                const metadataResponse = await window.gapi.client.sheets.spreadsheets.get({
                  spreadsheetId: googleSheetId
                });
                
                if (metadataResponse.status === 200 && metadataResponse.result.sheets) {
                  const targetSheet = metadataResponse.result.sheets.find(sheet => {
                    return sheet.properties.title === selectedSheetName;
                  });
                  
                  if (targetSheet) {
                    currentSheetGid = targetSheet.properties.sheetId.toString();
                    sheetNameToGidMap[selectedSheetName] = currentSheetGid; // Mapping-–¥ —Ö–∞–¥–≥–∞–ª–∞—Ö
                    console.log(`–°–æ–Ω–≥–æ—Å–æ–Ω sheet metadata-–∞–∞—Å –æ–ª–¥–ª–æ–æ: "${sheetName}" (GID: ${currentSheetGid})`);
                  }
                }
              } catch (metadataErr) {
                console.warn("Spreadsheet metadata –∞–≤–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞:", metadataErr);
              }
            }
            
            // Sheet name –±–∞–π—Ö–≥“Ø–π –±–æ–ª fallback (–∑”©–≤—Ö”©–Ω API-–∞–∞—Å –æ–ª–¥–æ—Ö–≥“Ø–π —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥)
            if (!sheetName || sheetName.trim() === '') {
              const sheets = workbook?.SheetNames || (workbook ? Object.keys(workbook.Sheets) : []);
              if (sheets.length > 0) {
                sheetName = sheets[0];
                console.log("Sheet name –±–∞–π—Ö–≥“Ø–π –±–∞–π—Å–∞–Ω, —ç—Ö–Ω–∏–π sheet –∞—à–∏–≥–ª–∞–∂ –±–∞–π–Ω–∞:", sheetName);
              } else {
                showError("Sheet –Ω—ç—Ä –æ–ª–¥—Å–æ–Ω–≥“Ø–π. Sheet —Å–æ–Ω–≥–æ–Ω–æ —É—É.");
                return;
              }
            }
            
            // Sheet name-–∏–π–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö (escape —Ö–∏–π—Ö—ç—ç—Å ”©–º–Ω”©) - API-–∞–∞—Å –∏—Ä—Å—ç–Ω –∑”©–≤ sheet name
            const originalSheetName = sheetName;
            console.log("Sheet name (API-–∞–∞—Å –∏—Ä—Å—ç–Ω):", originalSheetName);
            
            // Sheet name-–¥ —Ç—É—Å–≥–∞–π —Ç—ç–º–¥—ç–≥—Ç –±–∞–π–≤–∞–ª escape —Ö–∏–π—Ö (Google Sheets API-–¥ —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π)
            // –ó”©–≤—Ö”©–Ω –∑–∞–π, single quote, —ç—Å–≤—ç–ª ! –±–∞–π–≤–∞–ª escape —Ö–∏–π—Ö
            // –í–ê–ñ–ù–û: Cyrillic —Ç—ç–º–¥—ç–≥—Ç“Ø“Ø–¥–∏–π–≥ ”©”©—Ä—á–ª”©—Ö–≥“Ø–π!
            console.log("Escape —Ö–∏–π—Ö—ç—ç—Å ”©–º–Ω”© sheetName:", sheetName, "Type:", typeof sheetName, "Length:", sheetName.length, "Char codes:", Array.from(sheetName).map(c => c.charCodeAt(0)));
            
            let escapedSheetName = sheetName;
            if (sheetName.includes(' ') || sheetName.includes("'") || sheetName.includes('!')) {
              escapedSheetName = `'${sheetName.replace(/'/g, "''")}'`;
              console.log("Escape —Ö–∏–π—Å—ç–Ω:", escapedSheetName);
            } else {
              console.log("Escape —Ö–∏–π—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π, sheetName-–∏–π–≥ —à—É—É–¥ –∞—à–∏–≥–ª–∞–∂ –±–∞–π–Ω–∞");
            }
            
            console.log("–≠—Ü—Å–∏–π–Ω escapedSheetName:", escapedSheetName, "Char codes:", Array.from(escapedSheetName).map(c => c.charCodeAt(0)));
            
            // Column letter-–∏–π–≥ —Ç–æ–æ—Ü–æ–æ–ª–æ—Ö (A, B, C, ..., Z, AA, AB, ...)
            const getColumnLetter = (colIndex) => {
              let result = '';
              let num = colIndex;
              while (num >= 0) {
                result = String.fromCharCode(65 + (num % 26)) + result;
                num = Math.floor(num / 26) - 1;
              }
              return result;
            };
            
            const colLetter = getColumnLetter(oorchloltColIndexToUse);
            // Header –º”©—Ä–∏–π–Ω –¥–∞—Ä–∞–∞ —ç—Ö–ª—ç—Ö
            // headerRowIndex –Ω—å Google Sheets –¥—ç—ç—Ä—Ö header –º”©—Ä–∏–π–Ω –¥—É–≥–∞–∞—Ä (1-based)
            const startRow = headerRowIndex + 1; // Header-–∏–π–Ω –¥–∞—Ä–∞–∞ —ç—Ö–ª—ç—Ö
            const endRow = startRow + sheetData.length - 1; // –°“Ø“Ø–ª–∏–π–Ω –º”©—Ä
            const range = `${escapedSheetName}!${colLetter}${startRow}:${colLetter}${endRow}`;
            
            console.log("Range —Ç–æ–æ—Ü–æ–æ–ª–æ–ª:", {
              sheetNameFromDropdown: sheetSelect.value,
              sheetNameFromAPI: originalSheetName,
              escapedSheetName: escapedSheetName,
              colLetter,
              oorchloltColIndex: oorchloltColIndexToUse,
              headerRowIndex,
              startRow,
              endRow,
              range,
              sheetDataLength: sheetData.length,
              headers: headers,
              googleSheetGid: googleSheetGid
            });

            // "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω –∏–Ω–¥–µ–∫—Å–∏–π–≥ –æ–ª–æ—Ö (fallback —É—Ç–≥–∞ –∞–≤–∞—Ö–∞–¥ –∞—à–∏–≥–ª–∞–Ω–∞)
            let tavlynUtgaColIndex = headers.findIndex(h => {
              const headerStr = (h || "").toString().trim();
              return /—Ç–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞/i.test(headerStr);
            });
            
            console.log("–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞ –±–∞–≥–∞–Ω–∞ —à–∞–ª–≥–∞–ª—Ç:", {
              tavlynUtgaColIndex,
              headers,
              headersDetailed: headers.map((h, i) => ({ 
                index: i, 
                name: h, 
                test: /—Ç–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞/i.test(h || "") 
              }))
            });
            
            if (tavlynUtgaColIndex < 0) {
              // Fallback: viewHeaders-—ç—ç—Å –æ–ª–æ—Ö
              const viewTavlynUtgaColIndex = viewHeaders.findIndex(h => {
                const headerStr = (h || "").toString().trim();
                return /—Ç–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞/i.test(headerStr);
              });
              
              if (viewTavlynUtgaColIndex >= 0) {
                const viewHeaderName = viewHeaders[viewTavlynUtgaColIndex];
                const matchedHeaderIndex = headers.findIndex(h => h === viewHeaderName);
                if (matchedHeaderIndex >= 0) {
                  tavlynUtgaColIndex = matchedHeaderIndex;
                  console.log("ViewHeaders-—ç—ç—Å '–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞' –æ–ª–¥–ª–æ–æ (headers-–¥ match):", tavlynUtgaColIndex);
                } else if (viewTavlynUtgaColIndex < headers.length) {
                  tavlynUtgaColIndex = viewTavlynUtgaColIndex;
                  console.log("ViewHeaders-–∏–π–Ω index-–∏–π–≥ –∞—à–∏–≥–ª–∞–∂ –±–∞–π–Ω–∞:", tavlynUtgaColIndex);
                }
              }
              
              if (tavlynUtgaColIndex < 0) {
                // IP sheet-–∏–π–Ω —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥ "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω–∞ —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π
                // Sheet-–∏–π–Ω –Ω—ç—Ä—ç–Ω–¥ "IP" –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö
                const sheetNameForCheck = sheetSelect.value || "";
                const isIPSheetForWarning = /IP/i.test(sheetNameForCheck);
                if (!isIPSheetForWarning) {
                  console.warn("'–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞' –±–∞–≥–∞–Ω–∞ –æ–ª–¥—Å–æ–Ω–≥“Ø–π! –•–∞–¥–≥–∞–ª–∞—Ö –ª–æ–≥–∏–∫ –∑”©–≤ –∞–∂–∏–ª–ª–∞—Ö–≥“Ø–π –±–∞–π–∂ –º–∞–≥–∞–¥–≥“Ø–π.");
                }
              }
            }
            
            // Sheet-–∏–π–Ω –Ω—ç—Ä—ç–Ω–¥ "IP" –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö (selectedSheetName –¥—ç—ç—Ä—Ö—ç—ç—Å –∞—à–∏–≥–ª–∞–Ω–∞)
            const isIPSheet = /IP/i.test(selectedSheetName);
            
            // Versioning —Å–∏—Å—Ç–µ–º: "”®”©—Ä—á–ª”©–ª—Ç 1", "”®”©—Ä—á–ª”©–ª—Ç 2" –≥—ç—Ö –º—ç—Ç –±–∞–≥–∞–Ω–∞ “Ø“Ø—Å–≥—ç—Ö
            // –ì—ç—Ö–¥—ç—ç IP sheet –±–æ–ª versioning —Ö–∏–π—Ö–≥“Ø–π
            let newOorchloltColName = null;
            if (!isIPSheet) {
              // –≠—Ö–ª—ç—ç–¥ –æ–¥–æ–æ–≥–∏–π–Ω "”®”©—Ä—á–ª”©–ª—Ç" –±–∞–≥–∞–Ω—É—É–¥—ã–≥ –æ–ª–æ—Ö
              const existingOorchloltCols = headers
                .map((h, idx) => ({ name: h, index: idx }))
                .filter(({ name }) => /^”©”©—Ä—á–ª”©–ª—Ç\s*\d*$/i.test(name.trim()));
              
              // –î–∞—Ä–∞–∞–≥–∏–π–Ω version –¥—É–≥–∞–∞—Ä—ã–≥ –æ–ª–æ—Ö
              let nextVersion = 1;
              if (existingOorchloltCols.length > 0) {
                const versionNumbers = existingOorchloltCols
                  .map(({ name }) => {
                    const match = name.match(/\d+/);
                    return match ? parseInt(match[0]) : 0;
                  })
                  .filter(n => n > 0);
                if (versionNumbers.length > 0) {
                  nextVersion = Math.max(...versionNumbers) + 1;
                }
              }
              
              newOorchloltColName = `”®”©—Ä—á–ª”©–ª—Ç ${nextVersion}`;
              console.log("Versioning:", {
                existingOorchloltCols: existingOorchloltCols.map(c => c.name),
                nextVersion,
                newOorchloltColName
              });
            } else {
              console.log("IP sheet –±–∞–π–Ω–∞, versioning —Ö–∏–π—Ö–≥“Ø–π");
            }
            
            // –£—Ç–≥—É—É–¥—ã–≥ –±—ç–ª—Ç–≥—ç—Ö - "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –±–∞–≥–∞–Ω–∞–¥ —É—Ç–≥–∞ –±–∞–π–≥–∞–∞ –Ω“Ø–¥–Ω“Ø“Ø–¥—ç–¥ —à–∏–Ω—ç version –∞—à–∏–≥–ª–∞—Ö
            // IP sheet –±–∏—à –±–æ–ª —ç–Ω—ç –ª–æ–≥–∏–∫–∏–π–≥ –∞—à–∏–≥–ª–∞—Ö
            if (!isIPSheet) {
              // –≠—Ö–ª—ç—ç–¥ DOM-–æ–æ—Å –±“Ø—Ö input field-“Ø“Ø–¥–∏–π–Ω —É—Ç–≥—ã–≥ –∞–≤–∞—Ö
              const allInputs = document.querySelectorAll('input.editable-input[data-row][data-field]');
              console.log("DOM-–æ–æ—Å input field-“Ø“Ø–¥–∏–π–≥ –æ–ª–∂ –±–∞–π–Ω–∞:", {
                inputsCount: allInputs.length,
                oorchloltColIndexToUse,
                oorchloltHeaderName: oorchloltColIndexToUse >= 0 ? headers[oorchloltColIndexToUse] : "N/A"
              });
              
              // DOM-–æ–æ—Å —É—Ç–≥—É—É–¥—ã–≥ –∞–≤–∞—Ö
              allInputs.forEach(input => {
                const rowIndex = parseInt(input.getAttribute('data-row'));
                const field = input.getAttribute('data-field');
                const value = input.value.trim();
                if (rowIndex !== null && field) {
                  const key = `${rowIndex}_${field}`;
                  inputValues.set(key, value);
                  console.log("Input value —Ö–∞–¥–≥–∞–ª–∂ –±–∞–π–Ω–∞:", { key, value, rowIndex, field });
                }
              });
              
              console.log("InputValues Map:", {
                size: inputValues.size,
                entries: Array.from(inputValues.entries()).slice(0, 5)
              });
            }
            
            // IP sheet –±–∏—à –±–æ–ª "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" —É—Ç–≥—É—É–¥—ã–≥ –±—ç–ª—Ç–≥—ç—Ö
            const tavilOruulahValues = !isIPSheet && oorchloltColIndexToUse >= 0 ? sheetData.map((row, idx) => {
              // –≠—Ö–ª—ç—ç–¥ editable input field-—ç—ç—Å —É—Ç–≥–∞ –∞–≤–∞—Ö
              const inputKey = `${row.__rowIndex}_${headers[oorchloltColIndexToUse]}`;
              let tavilOruulahVal = inputValues.get(inputKey) || "";
              
              console.log(`Row ${idx} (${row.__rowIndex}): "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" —É—Ç–≥–∞ –∞–≤–∞—Ö:`, {
                inputKey,
                fromInputValues: tavilOruulahVal,
                fromSheetData: row[headers[oorchloltColIndexToUse]] || "",
                headerName: headers[oorchloltColIndexToUse]
              });
              
              // –•—ç—Ä—ç–≤ input field-—ç—ç—Å —É—Ç–≥–∞ –±–∞–π—Ö–≥“Ø–π –±–æ–ª, DOM-–æ–æ—Å —à—É—É–¥ –∞–≤–∞—Ö
              if (!tavilOruulahVal || tavilOruulahVal.trim() === "") {
                const inputElement = document.querySelector(`input.editable-input[data-row="${row.__rowIndex}"][data-field="${headers[oorchloltColIndexToUse]}"]`);
                if (inputElement) {
                  tavilOruulahVal = inputElement.value.trim();
                  console.log(`Row ${idx}: DOM-–æ–æ—Å —à—É—É–¥ —É—Ç–≥–∞ –∞–≤–ª–∞–∞: "${tavilOruulahVal}"`);
                }
              }
              
              // –•—ç—Ä—ç–≤ input field-—ç—ç—Å —É—Ç–≥–∞ –±–∞–π—Ö–≥“Ø–π –±–æ–ª, –∞–Ω—Ö–Ω—ã sheetData-–∞–∞—Å –∞–≤–∞—Ö
              if (!tavilOruulahVal || tavilOruulahVal.trim() === "") {
                tavilOruulahVal = row[headers[oorchloltColIndexToUse]] || "";
                console.log(`Row ${idx}: sheetData-–∞–∞—Å —É—Ç–≥–∞ –∞–≤–ª–∞–∞: "${tavilOruulahVal}"`);
              }
              
              // –•—ç—Ä—ç–≤ "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –±–∞–≥–∞–Ω–∞–¥ —É—Ç–≥–∞ –±–∞–π—Ö–≥“Ø–π –±–æ–ª, "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—ã–≥ –∞—à–∏–≥–ª–∞—Ö
              if (!tavilOruulahVal || tavilOruulahVal.toString().trim() === "") {
                if (tavlynUtgaColIndex >= 0) {
                  const tavlynUtgaVal = row[headers[tavlynUtgaColIndex]] || "";
                  if (tavlynUtgaVal && tavlynUtgaVal.toString().trim() !== "") {
                    tavilOruulahVal = tavlynUtgaVal;
                    console.log(`Row ${idx}: "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞, "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞"-–∞–∞—Å —É—Ç–≥–∞ –∞–≤–ª–∞–∞: "${tavilOruulahVal}"`);
                  }
                }
              }
              
              return tavilOruulahVal;
            }) : [];
            
            console.log("–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö —É—Ç–≥—É—É–¥:", {
              count: tavilOruulahValues.length,
              firstFew: tavilOruulahValues.slice(0, 5)
            });
            
            // "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω –±–∞—Ä—É—É–Ω —Ç–∞–ª—ã–Ω (–∞—Ä—ã–Ω) –±–∞–≥–Ω–∏–π –∏–Ω–¥–µ–∫—Å–∏–π–≥ –æ–ª–æ—Ö
            const tavlynUtgaRightColIndex = tavlynUtgaColIndex >= 0 ? tavlynUtgaColIndex + 1 : -1;
            
            console.log("–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞ –±–∞–≥–∞–Ω—ã–Ω –±–∞—Ä—É—É–Ω —Ç–∞–ª—ã–Ω –±–∞–≥–∞–Ω–∞:", {
              tavlynUtgaColIndex,
              tavlynUtgaRightColIndex,
              rightColHeader: tavlynUtgaRightColIndex >= 0 && tavlynUtgaRightColIndex < headers.length ? headers[tavlynUtgaRightColIndex] : "–û–ª–¥—Å–æ–Ω–≥“Ø–π",
              headersLength: headers.length,
              headers
            });
            
            // "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—É—É–¥—ã–≥ –±—ç–ª—Ç–≥—ç—Ö
            // "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω –±–∞—Ä—É—É–Ω —Ç–∞–ª—ã–Ω (–∞—Ä—ã–Ω) –±–∞–≥–Ω–∏–π —É—Ç–≥—ã–≥ –∞—à–∏–≥–ª–∞—Ö
            const tavlynUtgaValues = sheetData.map((row, idx) => {
              // –≠—Ö–ª—ç—ç–¥ "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω –±–∞—Ä—É—É–Ω —Ç–∞–ª—ã–Ω –±–∞–≥–Ω–∏–π —É—Ç–≥—ã–≥ –∞–≤–∞—Ö
              if (tavlynUtgaRightColIndex >= 0 && tavlynUtgaRightColIndex < headers.length) {
                const rightColVal = row[headers[tavlynUtgaRightColIndex]] || "";
                if (rightColVal && rightColVal.toString().trim() !== "") {
                  console.log(`Row ${idx}: "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω –±–∞—Ä—É—É–Ω —Ç–∞–ª—ã–Ω –±–∞–≥–Ω–∏–π —É—Ç–≥–∞: "${rightColVal}"`);
                  return rightColVal;
                }
              }
              
              // –•—ç—Ä—ç–≤ –±–∞—Ä—É—É–Ω —Ç–∞–ª—ã–Ω –±–∞–≥–Ω–∏–π —É—Ç–≥–∞ –±–∞–π—Ö–≥“Ø–π –±–æ–ª, "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—ã–≥ –∞—à–∏–≥–ª–∞—Ö
              const tavilOruulahVal = tavilOruulahValues[idx] || "";
              if (tavilOruulahVal && tavilOruulahVal.toString().trim() !== "") {
                return tavilOruulahVal;
              }
              
              // –•—ç—Ä—ç–≤ "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –±–∞–≥–∞–Ω–∞–¥ —É—Ç–≥–∞ –±–∞–π—Ö–≥“Ø–π –±–æ–ª, –∞–Ω—Ö–Ω—ã "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—ã–≥ –∞—à–∏–≥–ª–∞—Ö
              if (tavlynUtgaColIndex >= 0) {
                return row[headers[tavlynUtgaColIndex]] || "";
              }
              
              return "";
            });
            
            // "”®”©—Ä—á–ª”©–ª—Ç N" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—É—É–¥—ã–≥ –±—ç–ª—Ç–≥—ç—Ö
            // "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω –±–∞—Ä—É—É–Ω —Ç–∞–ª—ã–Ω (–∞—Ä—ã–Ω) –±–∞–≥–Ω–∏–π —É—Ç–≥—ã–≥ –∞—à–∏–≥–ª–∞—Ö
            const oorchloltValues = sheetData.map((row, idx) => {
              // –≠—Ö–ª—ç—ç–¥ "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω –±–∞—Ä—É—É–Ω —Ç–∞–ª—ã–Ω –±–∞–≥–Ω–∏–π —É—Ç–≥—ã–≥ –∞–≤–∞—Ö
              if (tavlynUtgaRightColIndex >= 0 && tavlynUtgaRightColIndex < headers.length) {
                const rightColVal = row[headers[tavlynUtgaRightColIndex]] || "";
                if (rightColVal && rightColVal.toString().trim() !== "") {
                  return rightColVal;
                }
              }
              
              // –•—ç—Ä—ç–≤ –±–∞—Ä—É—É–Ω —Ç–∞–ª—ã–Ω –±–∞–≥–Ω–∏–π —É—Ç–≥–∞ –±–∞–π—Ö–≥“Ø–π –±–æ–ª, "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—ã–≥ –∞—à–∏–≥–ª–∞—Ö
              const tavilOruulahVal = tavilOruulahValues[idx] || "";
              if (tavilOruulahVal && tavilOruulahVal.toString().trim() !== "") {
                return tavilOruulahVal;
              }
              
              // –•—ç—Ä—ç–≤ "–¢–∞–≤–∏–ª –æ—Ä—É—É–ª–∞—Ö" –±–∞–≥–∞–Ω–∞–¥ —É—Ç–≥–∞ –±–∞–π—Ö–≥“Ø–π –±–æ–ª, –∞–Ω—Ö–Ω—ã "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—ã–≥ –∞—à–∏–≥–ª–∞—Ö
              if (tavlynUtgaColIndex >= 0) {
                return row[headers[tavlynUtgaColIndex]] || "";
              }
              
              return "";
            });
            
            console.log("–•–∞–¥–≥–∞–ª–∞—Ö —É—Ç–≥—É—É–¥:", {
              tavlynUtgaValuesCount: tavlynUtgaValues.length,
              oorchloltValuesCount: oorchloltValues.length,
              tavlynUtgaFirstFew: tavlynUtgaValues.slice(0, 5),
              oorchloltFirstFew: oorchloltValues.slice(0, 5)
            });

            try {
              // Google Sheets –¥—ç—ç—Ä —Ö–∞–¥–≥–∞–ª–∞—Ö - Versioning —Å–∏—Å—Ç–µ–º
              console.log("Google Sheets –¥—ç—ç—Ä —Ö–∞–¥–≥–∞–ª–∞—Ö —ç—Ö—ç–ª–∂ –±–∞–π–Ω–∞ (Versioning)...", {
                spreadsheetId: googleSheetId,
                tavlynUtgaColIndex,
                newOorchloltColName,
                tavilOruulahValuesCount: tavilOruulahValues.length,
                tavlynUtgaValuesCount: tavlynUtgaValues.length
              });
              
              // 1. IP sheet –±–∏—à –±–æ–ª "–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞" –±–∞–≥–∞–Ω—ã–≥ —à–∏–Ω—ç—á–ª—ç—Ö
              let totalUpdatedCells = 0;
              let totalUpdatedRows = 0;
              
              if (!isIPSheet && tavlynUtgaColIndex >= 0) {
                const tavlynUtgaColLetter = getColumnLetter(tavlynUtgaColIndex);
                const tavlynUtgaRange = `${escapedSheetName}!${tavlynUtgaColLetter}${startRow}:${tavlynUtgaColLetter}${endRow}`;
                const tavlynUtgaUpdateValues = tavlynUtgaValues.map(v => [v]);
                
                console.log("–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞ –±–∞–≥–∞–Ω—ã–≥ —à–∏–Ω—ç—á–ª—ç–∂ –±–∞–π–Ω–∞:", {
                  range: tavlynUtgaRange,
                  colIndex: tavlynUtgaColIndex,
                  colLetter: tavlynUtgaColLetter,
                  valuesCount: tavlynUtgaUpdateValues.length,
                  firstFewValues: tavlynUtgaUpdateValues.slice(0, 5)
                });
                
                try {
                  const tavlynUtgaResponse = await window.gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: googleSheetId,
                    range: tavlynUtgaRange,
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                      values: tavlynUtgaUpdateValues
                    }
                  });
                  
                  if (tavlynUtgaResponse && tavlynUtgaResponse.status === 200) {
                    totalUpdatedCells += tavlynUtgaResponse.result?.updatedCells || 0;
                    totalUpdatedRows += tavlynUtgaResponse.result?.updatedRows || 0;
                    console.log("‚úÖ –¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞ –±–∞–≥–∞–Ω–∞ —à–∏–Ω—ç—á–ª—ç–≥–¥–ª—ç—ç:", {
                      updatedCells: tavlynUtgaResponse.result?.updatedCells,
                      updatedRows: tavlynUtgaResponse.result?.updatedRows,
                      range: tavlynUtgaRange
                    });
                  } else {
                    console.error("‚ùå –¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞ –±–∞–≥–∞–Ω–∞ —à–∏–Ω—ç—á–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞:", tavlynUtgaResponse);
                  }
                } catch (tavlynUtgaErr) {
                  console.error("‚ùå –¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞ –±–∞–≥–∞–Ω–∞ —à–∏–Ω—ç—á–ª—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ (catch):", tavlynUtgaErr);
                }
              } else if (isIPSheet) {
                console.log("IP sheet –±–∞–π–Ω–∞, '–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞' –±–∞–≥–∞–Ω—ã–≥ —à–∏–Ω—ç—á–ª—ç—Ö–≥“Ø–π (–∑”©–≤—Ö”©–Ω ”©”©—Ä—á–ª”©—Å”©–Ω –Ω“Ø–¥–Ω“Ø“Ø–¥—ç–¥ –ª —Ö–∞–¥–≥–∞–ª–∞—Ö)");
              } else {
                console.warn("‚ö†Ô∏è '–¢–∞–≤–∏–ª—ã–Ω —É—Ç–≥–∞' –±–∞–≥–∞–Ω–∞ –æ–ª–¥—Å–æ–Ω–≥“Ø–π, —à–∏–Ω—ç—á–ª—ç—Ö–≥“Ø–π –±–∞–π–Ω–∞!");
              }
              
              // 2. IP sheet –±–∏—à –±–æ–ª "”®”©—Ä—á–ª”©–ª—Ç N" –±–∞–≥–∞–Ω–∞ –Ω—ç–º—ç—Ö (—ç—Å–≤—ç–ª —à–∏–Ω—ç—á–ª—ç—Ö)
              if (!isIPSheet && newOorchloltColName) {
                // –≠—Ö–ª—ç—ç–¥ header –º”©—Ä”©–Ω–¥ "”®”©—Ä—á–ª”©–ª—Ç N" –±–∞–≥–∞–Ω–∞ –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö
                const headerRange = `${escapedSheetName}!${getColumnLetter(headers.length)}${headerRowIndex}:${getColumnLetter(headers.length + 10)}${headerRowIndex}`;
                
                // Header –º”©—Ä–∏–π–≥ —É–Ω—à–∏—Ö (–æ–¥–æ–æ–≥–∏–π–Ω —Å–æ–Ω–≥–æ—Å–æ–Ω sheet-–∞–∞—Å)
                const headerResponse = await window.gapi.client.sheets.spreadsheets.values.get({
                  spreadsheetId: googleSheetId,
                  range: `${escapedSheetName}!${headerRowIndex}:${headerRowIndex}`
                });
                
                let headerRow = [];
                if (headerResponse && headerResponse.status === 200 && headerResponse.result.values) {
                  headerRow = headerResponse.result.values[0] || [];
                }
                
                // –ë“Ø—Ö "”®”©—Ä—á–ª”©–ª—Ç N" –±–∞–≥–∞–Ω—É—É–¥—ã–≥ –æ–ª–æ—Ö (headerRow-–æ–æ—Å)
                const allOorchloltCols = headerRow
                  .map((h, idx) => ({ name: h, index: idx }))
                  .filter(({ name }) => name && /^”©”©—Ä—á–ª”©–ª—Ç\s+\d+$/i.test(name.toString().trim()));
                
                console.log("–ë“Ø—Ö '”®”©—Ä—á–ª”©–ª—Ç N' –±–∞–≥–∞–Ω—É—É–¥:", allOorchloltCols);
                
                // –•–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–∏–π–Ω "”®”©—Ä—á–ª”©–ª—Ç N" –±–∞–≥–∞–Ω—ã–≥ –æ–ª–æ—Ö
                let lastOorchloltColIndex = -1;
                if (allOorchloltCols.length > 0) {
                  // Version –¥—É–≥–∞–∞—Ä–∞–∞—Ä —ç—Ä—ç–º–±—ç–ª—ç—Ö
                  const sortedCols = allOorchloltCols.sort((a, b) => {
                    const aMatch = a.name.toString().match(/\d+/);
                    const bMatch = b.name.toString().match(/\d+/);
                    const aNum = aMatch ? parseInt(aMatch[0]) : 0;
                    const bNum = bMatch ? parseInt(bMatch[0]) : 0;
                    return aNum - bNum;
                  });
                  lastOorchloltColIndex = sortedCols[sortedCols.length - 1].index;
                  console.log("–•–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–∏–π–Ω '”®”©—Ä—á–ª”©–ª—Ç N' –±–∞–≥–∞–Ω–∞:", {
                    index: lastOorchloltColIndex,
                    name: headerRow[lastOorchloltColIndex]
                  });
                }
                
                // –®–∏–Ω—ç "”®”©—Ä—á–ª”©–ª—Ç N" –±–∞–≥–∞–Ω–∞ “Ø“Ø—Å–≥—ç—Ö
                let oorchloltColIndexInSheet = -1;
                
                // –•—ç—Ä—ç–≤ "”®”©—Ä—á–ª”©–ª—Ç N" –±–∞–≥–∞–Ω–∞ –±–∞–π–≥–∞–∞ –±–æ–ª, —Ö–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–∏–π–Ω—Ö –Ω—å –¥–∞—Ä–∞–∞ –Ω—ç–º—ç—Ö
                // –•—ç—Ä—ç–≤ –±–∞–π—Ö–≥“Ø–π –±–æ–ª, headers.length –±–∞–π—Ä–ª–∞–ª–¥ –Ω—ç–º—ç—Ö
                const insertColumnIndex = lastOorchloltColIndex >= 0 
                  ? lastOorchloltColIndex + 1 
                  : headers.length;
                
                console.log("–®–∏–Ω—ç –±–∞–≥–∞–Ω–∞ –Ω—ç–º—ç—Ö –±–∞–π—Ä–ª–∞–ª:", {
                  insertColumnIndex,
                  lastOorchloltColIndex,
                  headersLength: headers.length,
                  newOorchloltColName
                });
                
                // –ë–∞–≥–∞–Ω–∞ –Ω—ç–º—ç—Ö (insert column)
                const insertColumnRequest = {
                  insertDimension: {
                    range: {
                      sheetId: parseInt(currentSheetGid) || 0,
                      dimension: "COLUMNS",
                      startIndex: insertColumnIndex,
                      endIndex: insertColumnIndex + 1
                    },
                    inheritFromBefore: false
                  }
                };
                
                const batchUpdateResponse = await window.gapi.client.sheets.spreadsheets.batchUpdate({
                  spreadsheetId: googleSheetId,
                  resource: {
                    requests: [insertColumnRequest]
                  }
                });
                
                if (batchUpdateResponse && batchUpdateResponse.status === 200) {
                  console.log("‚úÖ –®–∏–Ω—ç –±–∞–≥–∞–Ω–∞ –Ω—ç–º—ç–≥–¥–ª—ç—ç:", {
                    insertColumnIndex,
                    newOorchloltColName
                  });
                  oorchloltColIndexInSheet = insertColumnIndex;
                } else {
                  console.error("‚ùå –ë–∞–≥–∞–Ω–∞ –Ω—ç–º—ç—Ö—ç–¥ –∞–ª–¥–∞–∞:", batchUpdateResponse);
                  // Fallback: headers.length –±–∞–π—Ä–ª–∞–ª–¥ –Ω—ç–º—ç—Ö
                  oorchloltColIndexInSheet = headers.length;
                }
                
                // Header –º”©—Ä”©–Ω–¥ "”®”©—Ä—á–ª”©–ª—Ç N" –Ω—ç–º—ç—Ö/—à–∏–Ω—ç—á–ª—ç—Ö
                const newHeaderColLetter = getColumnLetter(oorchloltColIndexInSheet);
                const newHeaderRange = `${escapedSheetName}!${newHeaderColLetter}${headerRowIndex}`;
                
                console.log("Header –º”©—Ä”©–Ω–¥ '”®”©—Ä—á–ª”©–ª—Ç N' –Ω—ç–º—ç–∂ –±–∞–π–Ω–∞:", {
                  range: newHeaderRange,
                  colIndex: oorchloltColIndexInSheet,
                  colLetter: newHeaderColLetter,
                  headerName: newOorchloltColName
                });
                
                await window.gapi.client.sheets.spreadsheets.values.update({
                  spreadsheetId: googleSheetId,
                  range: newHeaderRange,
                  valueInputOption: 'USER_ENTERED',
                  resource: {
                    values: [[newOorchloltColName]]
                  }
                });
                
                // "”®”©—Ä—á–ª”©–ª—Ç N" –±–∞–≥–∞–Ω—ã–Ω —É—Ç–≥—É—É–¥—ã–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö
                const oorchloltRange = `${escapedSheetName}!${newHeaderColLetter}${startRow}:${newHeaderColLetter}${endRow}`;
                const oorchloltUpdateValues = oorchloltValues.map(v => [v]);
                
                console.log("”®”©—Ä—á–ª”©–ª—Ç N –±–∞–≥–∞–Ω—ã–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö:", {
                  range: oorchloltRange,
                  colIndex: oorchloltColIndexInSheet,
                  colLetter: newHeaderColLetter,
                  valuesCount: oorchloltUpdateValues.length,
                  firstFewValues: oorchloltUpdateValues.slice(0, 5),
                  oorchloltValuesFirstFew: oorchloltValues.slice(0, 5),
                  tavilOruulahValuesFirstFew: tavilOruulahValues.slice(0, 5)
                });
                
                const oorchloltResponse = await window.gapi.client.sheets.spreadsheets.values.update({
                  spreadsheetId: googleSheetId,
                  range: oorchloltRange,
                  valueInputOption: 'USER_ENTERED',
                  resource: {
                    values: oorchloltUpdateValues
                  }
                });
                
                if (oorchloltResponse && oorchloltResponse.status === 200) {
                  totalUpdatedCells += oorchloltResponse.result?.updatedCells || 0;
                  totalUpdatedRows += oorchloltResponse.result?.updatedRows || 0;
                  console.log("”®”©—Ä—á–ª”©–ª—Ç N –±–∞–≥–∞–Ω–∞ —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞:", oorchloltResponse.result);
                }
              } else if (isIPSheet) {
                // IP sheet: –∑”©–≤—Ö”©–Ω ”©”©—Ä—á–ª”©—Å”©–Ω –Ω“Ø–¥–Ω“Ø“Ø–¥—ç–¥ –ª —Ö–∞–¥–≥–∞–ª–∞—Ö
                console.log("IP sheet –±–∞–π–Ω–∞, –∑”©–≤—Ö”©–Ω ”©”©—Ä—á–ª”©—Å”©–Ω –Ω“Ø–¥–Ω“Ø“Ø–¥—ç–¥ –ª —Ö–∞–¥–≥–∞–ª–∞—Ö");
                
                // –ë“Ø—Ö editable input field-“Ø“Ø–¥–∏–π–Ω —É—Ç–≥—ã–≥ –∞–≤–∞—Ö
                const allEditableInputs = document.querySelectorAll('input.editable-input[data-row][data-field]');
                const changedCells = [];
                
                console.log("IP sheet —Ö–∞–¥–≥–∞–ª–∞—Ö —ç—Ö–ª—ç–ª:", {
                  allEditableInputsCount: allEditableInputs.length,
                  sheetDataCount: sheetData.length,
                  headers: headers
                });
                
                allEditableInputs.forEach((input, inputIdx) => {
                  const rowIndex = parseInt(input.getAttribute('data-row'));
                  const field = input.getAttribute('data-field');
                  const newValue = input.value;
                  
                  // –ê–Ω—Ö–Ω—ã —É—Ç–≥—ã–≥ data-initial-value attribute-–æ–æ—Å –æ–ª–æ—Ö (–∏–ª“Ø“Ø –Ω–∞–π–¥–≤–∞—Ä—Ç–∞–π)
                  let originalValue = input.getAttribute('data-initial-value');
                  if (originalValue === null || originalValue === undefined) {
                    // Fallback: sheetData-–∞–∞—Å –æ–ª–æ—Ö
                    const row = sheetData.find(r => r.__rowIndex === rowIndex);
                    if (row) {
                      originalValue = row[field];
                      if (originalValue === null || originalValue === undefined) {
                        originalValue = "";
                      } else {
                        originalValue = String(originalValue);
                      }
                    } else {
                      originalValue = "";
                    }
                  } else {
                    originalValue = String(originalValue);
                  }
                  
                  // –®–∏–Ω—ç —É—Ç–≥—ã–≥ string –±–æ–ª–≥–æ—Ö
                  const newValueStr = String(newValue || "");
                  
                  // Debug: —ç—Ö–Ω–∏–π —Ö—ç–¥—ç–Ω input-–∏–π–≥ console-–¥ —Ö—ç–≤–ª—ç—Ö
                  if (inputIdx < 5) {
                    console.log(`Input ${inputIdx}: Row ${rowIndex}, Field "${field}", Original: "${originalValue}", New: "${newValueStr}", Same: ${newValueStr === originalValue}`);
                  }
                  
                  // –£—Ç–≥–∞ ”©”©—Ä—á–ª”©–≥–¥—Å”©–Ω —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö
                  if (newValueStr !== originalValue) {
                    // –ë–∞–≥–∞–Ω—ã–Ω –∏–Ω–¥–µ–∫—Å–∏–π–≥ –æ–ª–æ—Ö
                    const colIndex = headers.findIndex(h => h === field);
                    console.log(`”®”©—Ä—á–ª”©–ª—Ç –∏–ª—Ä—ç–ª—ç—ç: Row ${rowIndex}, Field "${field}", Col ${colIndex}, "${originalValue}" -> "${newValueStr}"`);
                    
                    if (colIndex >= 0) {
                      // –≠—Ö–Ω–∏–π 3 –±–∞–≥–∞–Ω–∞–∞—Å –±—É—Å–∞–¥ –±–∞–≥–∞–Ω—É—É–¥—ã–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö
                      if (colIndex >= 3) {
                        changedCells.push({
                          rowIndex: rowIndex,
                          colIndex: colIndex,
                          field: field,
                          newValue: newValueStr,
                          originalValue: originalValue
                        });
                        console.log(`‚úÖ ”®”©—Ä—á–ª”©–ª—Ç –Ω—ç–º—ç–≥–¥–ª—ç—ç: Row ${rowIndex}, Field "${field}", "${originalValue}" -> "${newValueStr}"`);
                      } else {
                        console.log(`‚ö†Ô∏è –≠—Ö–Ω–∏–π 3 –±–∞–≥–∞–Ω–∞ (Col ${colIndex}), —Ö–∞–¥–≥–∞–ª–∞—Ö–≥“Ø–π`);
                      }
                    } else {
                      console.log(`‚ùå –ë–∞–≥–∞–Ω–∞ –æ–ª–¥—Å–æ–Ω–≥“Ø–π: Field "${field}"`);
                    }
                  }
                });
                
                console.log("”®”©—Ä—á–ª”©–≥–¥—Å”©–Ω –Ω“Ø–¥–Ω“Ø“Ø–¥:", changedCells);
                
                // ”®”©—Ä—á–ª”©–≥–¥—Å”©–Ω –Ω“Ø–¥–Ω“Ø“Ø–¥—ç–¥ –ª —Ö–∞–¥–≥–∞–ª–∞—Ö
                if (changedCells.length > 0) {
                  // –ë–∞–≥–∞–Ω–∞–∞—Ä –±“Ø–ª—ç–≥–ª—ç—Ö
                  const cellsByColumn = {};
                  changedCells.forEach(cell => {
                    if (!cellsByColumn[cell.colIndex]) {
                      cellsByColumn[cell.colIndex] = [];
                    }
                    cellsByColumn[cell.colIndex].push(cell);
                  });
                  
                  // –ë–∞–≥–∞–Ω–∞–∞—Ä –±“Ø–ª—ç–≥–ª—ç—Ö –±”©–≥”©”©–¥ –º”©—Ä”©”©—Ä —ç—Ä—ç–º–±–ª—ç—Ö
                  for (const [colIndex, cells] of Object.entries(cellsByColumn)) {
                    const colIdx = parseInt(colIndex);
                    const colLetter = getColumnLetter(colIdx);
                    
                    // –ù“Ø–¥–Ω“Ø“Ø–¥–∏–π–≥ –º”©—Ä”©”©—Ä —ç—Ä—ç–º–±–ª—ç—Ö
                    const sortedCells = cells.sort((a, b) => {
                      const aRowIdx = sheetData.findIndex(r => r.__rowIndex === a.rowIndex);
                      const bRowIdx = sheetData.findIndex(r => r.__rowIndex === b.rowIndex);
                      return aRowIdx - bRowIdx;
                    });
                    
                    // –ú”©—Ä“Ø“Ø–¥–∏–π–≥ –æ–ª–æ—Ö
                    const rows = sortedCells.map(cell => {
                      const rowIdx = sheetData.findIndex(r => r.__rowIndex === cell.rowIndex);
                      return {
                        googleSheetRow: startRow + rowIdx,
                        value: cell.newValue,
                        originalValue: cell.originalValue
                      };
                    });
                    
                    console.log(`–ë–∞–≥–∞–Ω–∞ ${colLetter} (${colIdx}) —Ö–∞–¥–≥–∞–ª–∞—Ö:`, {
                      cellsCount: rows.length,
                      rows: rows.map(r => `row ${r.googleSheetRow}: "${r.originalValue}" -> "${r.value}"`)
                    });
                    
                    // values.update –∞—à–∏–≥–ª–∞—Ö (–∏–ª“Ø“Ø —Ö—è–ª–±–∞—Ä)
                    const rangeValues = rows.map(r => [r.value]);
                    const range = `${escapedSheetName}!${colLetter}${rows[0].googleSheetRow}:${colLetter}${rows[rows.length - 1].googleSheetRow}`;
                    
                    try {
                      const updateResponse = await window.gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: googleSheetId,
                        range: range,
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                          values: rangeValues
                        }
                      });
                      
                      if (updateResponse && updateResponse.status === 200) {
                        totalUpdatedCells += updateResponse.result?.updatedCells || rows.length;
                        totalUpdatedRows += updateResponse.result?.updatedRows || new Set(rows.map(r => r.googleSheetRow)).size;
                        console.log(`‚úÖ –ë–∞–≥–∞–Ω–∞ ${colLetter} (${colIdx}) —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞: ${rows.length} –Ω“Ø–¥, range: ${range}`);
                      } else {
                        console.error(`‚ùå –ë–∞–≥–∞–Ω–∞ ${colLetter} —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞:`, updateResponse);
                      }
                    } catch (updateErr) {
                      console.error(`‚ùå –ë–∞–≥–∞–Ω–∞ ${colLetter} —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ (catch):`, updateErr);
                      // Fallback: –Ω“Ø–¥ –±“Ø—Ä–∏–π–≥ —Ç—É—Å–∞–¥ –Ω—å —Ö–∞–¥–≥–∞–ª–∞—Ö
                      for (const row of rows) {
                        try {
                          const singleCellRange = `${escapedSheetName}!${colLetter}${row.googleSheetRow}`;
                          const singleUpdateResponse = await window.gapi.client.sheets.spreadsheets.values.update({
                            spreadsheetId: googleSheetId,
                            range: singleCellRange,
                            valueInputOption: 'USER_ENTERED',
                            resource: {
                              values: [[row.value]]
                            }
                          });
                          
                          if (singleUpdateResponse && singleUpdateResponse.status === 200) {
                            totalUpdatedCells += 1;
                            console.log(`‚úÖ –ù“Ø–¥ ${singleCellRange} —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞: "${row.value}"`);
                          }
                        } catch (singleErr) {
                          console.error(`‚ùå –ù“Ø–¥ ${colLetter}${row.googleSheetRow} —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞:`, singleErr);
                        }
                      }
                    }
                  }
                } else {
                  console.log("”®”©—Ä—á–ª”©–≥–¥—Å”©–Ω –Ω“Ø–¥ –æ–ª–¥—Å–æ–Ω–≥“Ø–π");
                  setStatus("‚ö†Ô∏è ”®”©—Ä—á–ª”©–ª—Ç –æ—Ä—É—É–ª–∞–∞–≥“Ø–π –±–∞–π–Ω–∞. –•–∞–¥–≥–∞–ª–∞—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π.");
                  return;
                }
              }
              
              const updateResponse = {
                status: 200,
                result: {
                  updatedCells: totalUpdatedCells,
                  updatedRows: totalUpdatedRows,
                  updatedColumns: 1
                }
              };

              console.log("Google Sheets update response:", updateResponse);
              console.log("IP sheet —Ö–∞–¥–≥–∞–ª–∞—Ö “Ø—Ä –¥“Ø–Ω:", {
                totalUpdatedCells,
                totalUpdatedRows,
                isIPSheet: true
              });
              
              // Response-–∏–π–≥ –Ω–∞—Ä–∏–π–≤—á–ª–∞–Ω —à–∞–ª–≥–∞—Ö
              if (updateResponse && updateResponse.status === 200) {
                const updatedCells = updateResponse.result?.updatedCells || 0;
                const updatedRows = updateResponse.result?.updatedRows || 0;
                const updatedColumns = updateResponse.result?.updatedColumns || 0;
                
                console.log("–•–∞–¥–≥–∞–ª–∞—Ö –∞–º–∂–∏–ª—Ç—Ç–∞–π:", {
                  status: updateResponse.status,
                  updatedCells,
                  updatedRows,
                  updatedColumns,
                  isIPSheet: isIPSheet
                });
                
                // –ê–º–∂–∏–ª—Ç—Ç–∞–π –º—ç–¥—ç—ç–ª—ç–ª —Ö–∞—Ä—É—É–ª–∞—Ö - —Ç–æ–≤—á, –æ–π–ª–≥–æ–º–∂—Ç–æ–π
                setStatus(`‚úÖ –ê–ú–ñ–ò–õ–¢–¢–ê–ô –•–ê–î–ì–ê–õ–ê–ì–î–õ–ê–ê!\n\n–•–∞–¥–≥–∞–ª—Å–∞–Ω: ${updatedRows} –º”©—Ä, ${updatedCells} –Ω“Ø–¥\n\nGoogle Sheets-—ç—ç—Å –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –¥–∞—Ö–∏–Ω —É–Ω—à–∏–∂ –±–∞–π–Ω–∞...`);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∞–∞—Ä Google Sheets-—ç—ç—Å –¥–∞—Ö–∏–Ω —É–Ω—à–∏—Ö (–æ–¥–æ–æ–≥–∏–π–Ω sheet-–∏–π–≥ —Ö–∞–¥–≥–∞–ª–∂)
                const currentSheetName = sheetSelect.value; // –û–¥–æ–æ–≥–∏–π–Ω —Å–æ–Ω–≥–æ—Å–æ–Ω sheet-–∏–π–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö
                setTimeout(async () => {
                  try {
                    await loadGoogleSheets();
                    // –û–¥–æ–æ–≥–∏–π–Ω —Å–æ–Ω–≥–æ—Å–æ–Ω sheet-–∏–π–≥ –¥–∞—Ö–∏–Ω —Å–æ–Ω–≥–æ—Ö
                    if (currentSheetName && sheetSelect) {
                      // Sheet dropdown-–∏–π–≥ –±—ç–ª—ç–Ω –±–æ–ª–æ—Ö–æ–¥ —Ö“Ø–ª—ç—ç—Ö
                      setTimeout(() => {
                        const optionExists = Array.from(sheetSelect.options).some(opt => opt.value === currentSheetName);
                        if (optionExists) {
                          sheetSelect.value = currentSheetName;
                          loadSheet(currentSheetName);
                          console.log(`‚úÖ Sheet —Å—ç—Ä–≥—ç—ç–ª—ç—ç: "${currentSheetName}"`);
                        } else {
                          console.warn(`Sheet "${currentSheetName}" –æ–ª–¥—Å–æ–Ω–≥“Ø–π, —ç—Ö–Ω–∏–π sheet –∞—à–∏–≥–ª–∞–∂ –±–∞–π–Ω–∞`);
                        }
                      }, 100);
                    }
                    setStatus(`‚úÖ –ê–ú–ñ–ò–õ–¢–¢–ê–ô –•–ê–î–ì–ê–õ–ê–ì–î–õ–ê–ê!\n\n–•–∞–¥–≥–∞–ª—Å–∞–Ω: ${updatedRows} –º”©—Ä, ${updatedCells} –Ω“Ø–¥\n\n‚úÖ Google Sheets-—ç—ç—Å –¥–∞—Ö–∏–Ω —É–Ω—à–ª–∞–∞.`);
                  } catch (refreshErr) {
                    console.error("–ê–≤—Ç–æ–º–∞—Ç–∞–∞—Ä refresh —Ö–∏–π—Ö—ç–¥ –∞–ª–¥–∞–∞:", refreshErr);
                    setStatus(`‚úÖ –ê–ú–ñ–ò–õ–¢–¢–ê–ô –•–ê–î–ì–ê–õ–ê–ì–î–õ–ê–ê!\n\n–•–∞–¥–≥–∞–ª—Å–∞–Ω: ${updatedRows} –º”©—Ä, ${updatedCells} –Ω“Ø–¥\n\n‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∞–∞—Ä refresh —Ö–∏–π—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –ì–∞—Ä–∞–∞—Ä "Google Sheets —É–Ω—à–∏—Ö" —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–∞–∞—Ä–∞–π.`);
                  }
                }, 1000); // 1 —Å–µ–∫—É–Ω–¥ —Ö“Ø–ª—ç—ç–≥—ç—ç–¥ refresh —Ö–∏–π—Ö
              } else {
                // Status 200 –±–∏—à –±–æ–ª –∞–ª–¥–∞–∞
                const errorMsg = updateResponse?.statusText || updateResponse?.result?.error?.message || 'Unknown error';
                console.error("–•–∞–¥–≥–∞–ª–∞—Ö –∞–ª–¥–∞–∞ (status !== 200):", {
                  status: updateResponse?.status,
                  statusText: updateResponse?.statusText,
                  error: updateResponse?.result?.error
                });
                showError(`‚ùå –ê–ú–ñ–ò–õ–¢–ì“Æ–ô –ë–û–õ–õ–û–û\n\n–ê–ª–¥–∞–∞: ${errorMsg}\n\n–ó”©–≤–ª”©–º–∂: Google Sheets ‚Üí Share ‚Üí "Editor" —ç—Ä—Ö ”©–≥”©—Ö`);
              }
            } catch (updateErr) {
              console.error("Google Sheets update –∞–ª–¥–∞–∞ (catch block):", updateErr);
              
              // –ê–ª–¥–∞–∞–Ω—ã —Ç”©—Ä–ª”©”©—Ä –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª —Ö–∞—Ä—É—É–ª–∞—Ö
              const errorStatus = updateErr.status || (updateErr.result?.error?.code);
              const errorMessage = updateErr.result?.error?.message || updateErr.message || 'Unknown error';
              
              console.error("–ê–ª–¥–∞–∞–Ω—ã –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π:", {
                status: errorStatus,
                message: errorMessage,
                error: updateErr.result?.error,
                fullError: updateErr
              });
              
              if (errorStatus === 403 || (updateErr.result && updateErr.result.error && updateErr.result.error.code === 403)) {
                // 403 Forbidden –∞–ª–¥–∞–∞
                showError(`‚ùå –ê–ú–ñ–ò–õ–¢–ì“Æ–ô: –≠–†–• –•“Æ–†–≠–•–ì“Æ–ô\n\n–®–∏–π–¥—ç–ª:\n1. Google Sheets ‚Üí Share ‚Üí Restricted –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö\n2. –ù—ç–≤—Ç—ç—Ä—Å—ç–Ω email-–∏–π–≥ Share –¥—ç—ç—Ä –Ω—ç–º—ç—Ö (Share ‚Üí Email –Ω—ç–º—ç—Ö ‚Üí "Editor" —ç—Ä—Ö ”©–≥”©—Ö)\n3. –•—ç—Ä—ç–≤ Restricted –±–∏—à –±–æ–ª Share ‚Üí "Editor" —ç—Ä—Ö ”©–≥”©—Ö`);
              } else if (errorStatus === 400 || (updateErr.result && updateErr.result.error && updateErr.result.error.code === 400)) {
                // 400 Bad Request –∞–ª–¥–∞–∞ - range —ç—Å–≤—ç–ª —É—Ç–≥–∞ –±—É—Ä—É—É –±–∞–π–Ω–∞
                console.error("400 –∞–ª–¥–∞–∞–Ω—ã –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π:", {
                  error: updateErr.result?.error,
                  range: range,
                  sheetNameFromDropdown: sheetSelect.value,
                  actualSheetName: originalSheetName,
                  escapedSheetName: escapedSheetName,
                  colLetter: colLetter,
                  oorchloltColIndex: oorchloltColIndexToUse,
                  headerRowIndex: headerRowIndex,
                  startRow: startRow,
                  endRow: endRow,
                  sheetDataLength: sheetData.length,
                  headers: headers,
                  googleSheetGid: googleSheetGid
                });
                showError(`‚ùå –ê–ú–ñ–ò–õ–¢–ì“Æ–ô: RANGE –ë–£–†–£–£\n\n–ê–ª–¥–∞–∞: ${errorMessage}\n\n–ó”©–≤–ª”©–º–∂: Console-–æ–æ—Å –¥—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª —Ö–∞—Ä–∞—Ö`);
              } else {
                // –ë—É—Å–∞–¥ –∞–ª–¥–∞–∞–Ω—É—É–¥
                showError(`‚ùå –ê–ú–ñ–ò–õ–¢–ì“Æ–ô –ë–û–õ–õ–û–û\n\n–ê–ª–¥–∞–∞: ${errorMessage}\n\n–ó”©–≤–ª”©–º–∂: –ò–Ω—Ç–µ—Ä–Ω—ç—Ç —Ö–æ–ª–±–æ–ª—Ç, Google Sheets —à–∞–ª–≥–∞—Ö`);
              }
            }
            } catch (performSaveErr) {
              console.error("performSave –∞–ª–¥–∞–∞:", performSaveErr);
              showError(`Google Sheets —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞:\n\n${performSaveErr?.message || performSaveErr}`);
            }
        };

        const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: 'https://www.googleapis.com/auth/spreadsheets',
          callback: async (response) => {
            if (response.error) {
              showError(`OAuth –∞–ª–¥–∞–∞: ${response.error}`);
              return;
            }

            // Access token-–∏–π–≥ —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö
            window.gapi.client.setToken(response);
            console.log("OAuth token –∞–≤–ª–∞–∞ (—Ö–∞–¥–≥–∞–ª–∞—Ö)");
            
            // –•–∞–¥–≥–∞–ª–∞—Ö –ª–æ–≥–∏–∫–∏–π–≥ –¥—É—É–¥–∞—Ö
            await performSave();
          }
        });

        // Token –∞–≤–∞—Ö - —Ö—ç—Ä—ç–≤ token –±–∞–π–≥–∞–∞ –±–æ–ª –¥–∞—Ö–∏–Ω –Ω—ç–≤—Ç—Ä—ç—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π
        if (!currentToken || !currentToken.access_token) {
          // Token –±–∞–π—Ö–≥“Ø–π –±–æ–ª consent –∞—Å—É—É—Ö
          // prompt: 'select_account' - account —Å–æ–Ω–≥–æ—Ö (1 —É–¥–∞–∞), –¥–∞—Ä–∞–∞ –Ω—å cookie-–¥ —Ö–∞–¥–≥–∞–ª–∞–≥–¥–∞–Ω–∞, –∏–ª“Ø“Ø —Ö—É—Ä–¥–∞–Ω
          // prompt: 'consent' - –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–ª—Ç –¥–∞—Ö–∏–Ω –∞—Å—É—É—Ö (–æ–ª–æ–Ω —Ü–∞–≥ –∞–≤–Ω–∞)
          // prompt: '' - –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –∞—à–∏–≥–ª–∞—Ö (token –±–∞–π–≥–∞–∞ –±–æ–ª)
          tokenClient.requestAccessToken({ prompt: 'select_account' });
        } else {
          // Token –±–∞–π–≥–∞–∞ –±–æ–ª —à—É—É–¥ —Ö–∞–¥–≥–∞–ª–∞—Ö –ª–æ–≥–∏–∫ —Ä—É—É –æ—Ä–Ω–æ
          window.gapi.client.setToken(currentToken);
          console.log("–û–¥–æ–æ–≥–∏–π–Ω OAuth token –∞—à–∏–≥–ª–∞–∂ –±–∞–π–Ω–∞ (–¥–∞—Ö—å —É–¥–∞–∞ –Ω—ç–≤—Ç—Ä—ç—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π)");
          
          // –•–∞–¥–≥–∞–ª–∞—Ö –ª–æ–≥–∏–∫–∏–π–≥ —à—É—É–¥ –¥—É—É–¥–∞—Ö
          await performSave();
        }
      } catch (err) {
        console.error("Google Sheets —Ö–∞–¥–≥–∞–ª–∞—Ö –∞–ª–¥–∞–∞:", err);
        showError(`Google Sheets —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞:\n\n${err?.message || err}\n\n–ó”©–≤–ª”©–º–∂:\n1. Google Cloud Console ‚Üí API & Services ‚Üí Credentials ‚Üí OAuth 2.0 Client ID “Ø“Ø—Å–≥—ç—Ö\n2. Client ID-–≥ –æ—Ä—É—É–ª–∞—Ö`);
      }
    });

    // Google Sheets URL-–∞–∞—Å ”©–≥”©–≥–¥”©–ª —É–Ω—à–∏—Ö —Ñ—É–Ω–∫—Ü (OAuth –∞—à–∏–≥–ª–∞—Ö)
    const loadGoogleSheets = async () => {
      const url = googleSheetsUrlInput.value.trim();
      if (!url) {
        showError("Google Sheets URL –æ—Ä—É—É–ª–Ω–∞ —É—É.");
        return;
      }

      // OAuth 2.0 Client ID —à–∞–ª–≥–∞—Ö
      const clientId = googleApiKeyInput.value.trim();
      if (!clientId) {
        showError("OAuth 2.0 Client ID –æ—Ä—É—É–ª–Ω–∞ —É—É.");
        return;
      }

      try {
        setStatus("Google Sheets —É–Ω—à–∏–∂ –±–∞–π–Ω–∞...");
        clearTable();
        clearHistoryTable();

        // Google Sheets URL-–∞–∞—Å Sheet ID –±–æ–ª–æ–Ω GID –æ–ª–æ—Ö
        let sheetId = null;
        let gid = "0"; // Default gid
        const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
        if (match) {
          sheetId = match[1];
          googleSheetId = sheetId; // –•–∞–¥–≥–∞–ª–∞—Ö
        } else {
          throw new Error("Google Sheets URL –±—É—Ä—É—É –±–∞–π–Ω–∞. –ñ–∏—à—ç—ç: https://docs.google.com/spreadsheets/d/SHEET_ID/edit");
        }
        
        // GID –æ–ª–æ—Ö (URL-–¥ gid –ø–∞—Ä–∞–º–µ—Ç—Ä –±–∞–π–≤–∞–ª –∞—à–∏–≥–ª–∞—Ö)
        const gidMatch = url.match(/[?&#]gid=(\d+)/);
        if (gidMatch) {
          gid = gidMatch[1];
          googleSheetGid = gid; // –•–∞–¥–≥–∞–ª–∞—Ö
          console.log(`GID –æ–ª–¥–ª–æ–æ: ${gid}`);
        } else {
          googleSheetGid = "0"; // Default GID
        }

        // gapi client –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö (—Ö—ç—Ä—ç–≤ —Ö–∏–π–≥–¥—ç—ç–≥“Ø–π –±–æ–ª)
        if (!window.gapi || !window.gapi.client || !window.gapi.client.sheets) {
          setStatus("Google API –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª–∂ –±–∞–π–Ω–∞...");
          if (!window.gapi) {
            throw new Error("Google API library –∞—á–∞–∞–ª–∞–≥–¥–∞–∞–≥“Ø–π –±–∞–π–Ω–∞. –ò–Ω—Ç–µ—Ä–Ω—ç—Ç —Ö–æ–ª–±–æ–ª—Ç —à–∞–ª–≥–∞–∞—Ä–∞–π.");
          }
          
          await new Promise((resolve, reject) => {
            window.gapi.load('client', () => {
              window.gapi.client.init({
                'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                'clientId': clientId
              }).then(() => {
                console.log("Google API client –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç–≥–¥–ª—ç—ç");
                resolve();
              }).catch(reject);
            });
          });
        }

        // OAuth token —à–∞–ª–≥–∞—Ö —ç—Å–≤—ç–ª –∞–≤–∞—Ö (—Ö—ç—Ä—ç–≤ login —Ö–∏–π—Å—ç–Ω –±–æ–ª token –±–∞–π–Ω–∞, —Ü–∞–≥ –∞–ª–¥–∞—Ö–≥“Ø–π)
        const currentToken = window.gapi.client.getToken();
        if (!currentToken || !currentToken.access_token) {
          // Token –±–∞–π—Ö–≥“Ø–π –±–æ–ª —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–≥ login —Ö–∏–π—Ö –≥—ç–∂ —Å–∞–Ω–∞–∞ ”©–≥”©—Ö (–∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä popup –Ω—ç—ç—Ö–≥“Ø–π)
          setStatus("‚ö†Ô∏è –≠—Ö–ª—ç—ç–¥ 'Google-–¥ –Ω—ç–≤—Ç—Ä—ç—Ö' —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–∞–∞—Ä–∞–π. Token –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.");
          throw new Error("Token –±–∞–π—Ö–≥“Ø–π. –≠—Ö–ª—ç—ç–¥ 'Google-–¥ –Ω—ç–≤—Ç—Ä—ç—Ö' —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–∞–∞—Ä–∞–π.");
        } else {
          console.log("‚úÖ Token –∞–ª—å —Ö—ç–¥–∏–π–Ω –±–∞–π–Ω–∞ (login —Ö–∏–π—Å—ç–Ω), —Ü–∞–≥ –∞–ª–¥–∞—Ö–≥“Ø–π —à—É—É–¥ —É–Ω—à–∏–∂ –±–∞–π–Ω–∞");
        }

        // Google Sheets API-–∞–∞—Ä ”©–≥”©–≥–¥”©–ª —É–Ω—à–∏—Ö
        setStatus("Google Sheets API-–∞–∞—Ä ”©–≥”©–≥–¥”©–ª —É–Ω—à–∏–∂ –±–∞–π–Ω–∞...");
        
        // Spreadsheet metadata –∞–≤–∞—Ö
        const metadataResponse = await window.gapi.client.sheets.spreadsheets.get({
          spreadsheetId: sheetId
        });
        
        if (metadataResponse.status !== 200) {
          throw new Error(`Google Sheets metadata –∞–≤–∞—Ö–∞–¥ –∞–ª–¥–∞–∞: ${metadataResponse.statusText}`);
        }

        const spreadsheet = metadataResponse.result;
        console.log("Spreadsheet metadata:", spreadsheet);

        if (!spreadsheet.sheets || spreadsheet.sheets.length === 0) {
          throw new Error("Google Sheets –¥—ç—ç—Ä sheet –æ–ª–¥—Å–æ–Ω–≥“Ø–π.");
        }

        // –ë“Ø—Ö sheet-“Ø“Ø–¥–∏–π–≥ —É–Ω—à–∏—Ö
        workbook = {
          SheetNames: [],
          Sheets: {}
        };

        // –ë“Ø—Ö sheet-“Ø“Ø–¥–∏–π–≥ —É–Ω—à–∏—Ö
        for (const sheet of spreadsheet.sheets) {
          const sheetName = sheet.properties.title;
          const sheetGid = sheet.properties.sheetId;
          
          try {
            setStatus(`"${sheetName}" sheet —É–Ω—à–∏–∂ –±–∞–π–Ω–∞...`);
            
            // Sheet-–∏–π–Ω –±“Ø—Ö ”©–≥”©–≥–¥–ª–∏–π–≥ —É–Ω—à–∏—Ö (A1:Z1000 —Ö“Ø—Ä—Ç—ç–ª - –∏—Ö —Ö—ç–º–∂—ç—ç–Ω–∏–π ”©–≥”©–≥–¥”©–ª)
            const valuesResponse = await window.gapi.client.sheets.spreadsheets.values.get({
              spreadsheetId: sheetId,
              range: `${sheetName}!A1:Z1000`
            });

            if (valuesResponse.status === 200) {
              const values = valuesResponse.result.values || [];
              
              if (values.length > 0) {
                // XLSX —Ñ–æ—Ä–º–∞—Ç –±–æ–ª–≥–æ–Ω —Ö”©—Ä–≤“Ø“Ø–ª—ç—Ö
                const ws = XLSX.utils.aoa_to_sheet(values);
                workbook.Sheets[sheetName] = ws;
                workbook.SheetNames.push(sheetName);
                
                console.log(`"${sheetName}" sheet —É–Ω—à–ª–∞–∞: ${values.length} –º”©—Ä`);
              } else {
                // –•–æ–æ—Å–æ–Ω sheet-–∏–π–≥ –º”©–Ω –Ω—ç–º—ç—Ö
                const ws = XLSX.utils.aoa_to_sheet([[]]);
                workbook.Sheets[sheetName] = ws;
                workbook.SheetNames.push(sheetName);
                console.log(`"${sheetName}" sheet —Ö–æ–æ—Å–æ–Ω –±–∞–π–Ω–∞`);
              }
            } else {
              console.warn(`"${sheetName}" sheet —É–Ω—à–∏—Ö –∞–ª–¥–∞–∞: ${valuesResponse.statusText}`);
              // –ê–ª–¥–∞–∞ –≥–∞—Ä—Å–∞–Ω —á sheet-–∏–π–≥ –Ω—ç–º—ç—Ö (—Ö–æ–æ—Å–æ–Ω)
              const ws = XLSX.utils.aoa_to_sheet([[]]);
              workbook.Sheets[sheetName] = ws;
              workbook.SheetNames.push(sheetName);
            }
          } catch (sheetErr) {
            console.warn(`"${sheetName}" sheet —É–Ω—à–∏—Ö –∞–ª–¥–∞–∞:`, sheetErr);
            // –ê–ª–¥–∞–∞ –≥–∞—Ä—Å–∞–Ω —á sheet-–∏–π–≥ –Ω—ç–º—ç—Ö (—Ö–æ–æ—Å–æ–Ω)
            const ws = XLSX.utils.aoa_to_sheet([[]]);
            workbook.Sheets[sheetName] = ws;
            workbook.SheetNames.push(sheetName);
          }
        }

        if (workbook.SheetNames.length === 0) {
          throw new Error("–Ø–º–∞—Ä —á sheet —É–Ω—à–∏—Ö –±–æ–ª–æ–º–∂–≥“Ø–π –±–∞–π–Ω–∞.");
        }

        // Sheet name -> GID mapping “Ø“Ø—Å–≥—ç—Ö
        sheetNameToGidMap = {};
        if (spreadsheet.sheets) {
          spreadsheet.sheets.forEach(sheet => {
            const sheetName = sheet.properties.title;
            const sheetGid = sheet.properties.sheetId.toString();
            sheetNameToGidMap[sheetName] = sheetGid;
            console.log(`Sheet mapping: "${sheetName}" -> GID ${sheetGid}`);
          });
        }
        
        // GID-–∞–∞—Ä default sheet-–∏–π–≥ —Å–æ–Ω–≥–æ—Ö
        const targetGid = parseInt(gid) || 0;
        if (targetGid !== 0) {
          const targetSheet = spreadsheet.sheets.find(sheet => {
            return sheet.properties.sheetId === targetGid;
          });
          if (targetSheet) {
            googleSheetGid = targetSheet.properties.sheetId.toString();
            console.log(`Default sheet: "${targetSheet.properties.title}" (GID: ${googleSheetGid})`);
          }
        } else if (spreadsheet.sheets.length > 0) {
          // GID –±–∞–π—Ö–≥“Ø–π –±–æ–ª —ç—Ö–Ω–∏–π sheet-–∏–π–≥ default –±–æ–ª–≥–æ—Ö
          googleSheetGid = spreadsheet.sheets[0].properties.sheetId.toString();
          console.log(`Default sheet: "${spreadsheet.sheets[0].properties.title}" (GID: ${googleSheetGid})`);
        }
        
        console.log("Workbook —É–Ω—à–ª–∞–∞:", workbook);
        console.log(`–ù–∏–π—Ç ${workbook.SheetNames.length} sheet —É–Ω—à–ª–∞–∞:`, workbook.SheetNames);

        originalFileName = `Google Sheets - ${sheetId.substring(0, 8)}.xlsx`;
        setStatus(`–ê–º–∂–∏–ª—Ç—Ç–∞–π: Google Sheets —É–Ω—à–ª–∞–∞ (${workbook.SheetNames.length} sheet)`);
        
        // –û–¥–æ–æ–≥–∏–π–Ω —Å–æ–Ω–≥–æ—Å–æ–Ω sheet-–∏–π–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö (—Ö—ç—Ä—ç–≤ –±–∞–π–≥–∞–∞ –±–æ–ª)
        const currentSheetBeforeRefresh = sheetSelect.value;
        populateSheetDropdown();
        
        // –•—ç—Ä—ç–≤ refresh —Ö–∏–π—Ö—ç—ç—Å ”©–º–Ω”© sheet —Å–æ–Ω–≥–æ—Å–æ–Ω –±–∞–π—Å–∞–Ω –±–æ–ª –¥–∞—Ö–∏–Ω —Å–æ–Ω–≥–æ—Ö
        if (currentSheetBeforeRefresh && Array.from(sheetSelect.options).some(opt => opt.value === currentSheetBeforeRefresh)) {
          sheetSelect.value = currentSheetBeforeRefresh;
          loadSheet(currentSheetBeforeRefresh);
          console.log(`‚úÖ Sheet —Å—ç—Ä–≥—ç—ç–ª—ç—ç: "${currentSheetBeforeRefresh}"`);
        }
      } catch (err) {
        console.error("Google Sheets —É–Ω—à–∏—Ö –∞–ª–¥–∞–∞:", err);
        // Token –±–∞–π—Ö–≥“Ø–π –∞–ª–¥–∞–∞ —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥ —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–¥ –º—ç–¥—ç—ç–ª—ç–ª ”©–≥”©—Ö (popup –Ω—ç—ç—Ö–≥“Ø–π)
        if (err.message && (err.message.includes('Token –±–∞–π—Ö–≥“Ø–π') || err.message.includes('OAuth'))) {
          showError(`‚ö†Ô∏è Token –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.\n\n–®–∏–π–¥—ç–ª:\n1. –≠—Ö–ª—ç—ç–¥ "Google-–¥ –Ω—ç–≤—Ç—Ä—ç—Ö" —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–∞–∞—Ä–∞–π\n2. –î–∞—Ä–∞–∞ –Ω—å "Google Sheets —É–Ω—à–∏—Ö" —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ä–∞–∞—Ä–∞–π\n\nüí° –≠–Ω—ç –Ω—å reload —Ö–∏–π—Ö—ç–¥ popup –Ω—ç—ç–≥–¥—ç—Ö–≥“Ø–π –±–∞–π—Ö—ã–Ω —Ç—É–ª–¥ —Ö–∏–π–≥–¥—Å—ç–Ω.`);
        } else {
          showError(`Google Sheets —É–Ω—à–∏—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞:\n\n${err?.message || err}\n\n–ó”©–≤–ª”©–º–∂:\n1. Google Sheets-–¥ —Ö–∞–Ω–¥–∞—Ö —ç—Ä—Ö—Ç—ç–π —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö\n2. URL –∑”©–≤ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö\n3. –ò–Ω—Ç–µ—Ä–Ω—ç—Ç —Ö–æ–ª–±–æ–ª—Ç –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö`);
        }
      }
    };
    
    // Google-–¥ –Ω—ç–≤—Ç—Ä—ç—Ö —Ç–æ–≤—á (token –∞–≤–∞—Ö)
    const loginGoogleBtn = document.getElementById("login-google");
    const loginGoogle = async () => {
      const clientId = googleApiKeyInput.value.trim();
      if (!clientId) {
        showError("OAuth 2.0 Client ID –æ—Ä—É—É–ª–Ω–∞ —É—É.");
        return;
      }

      try {
        setStatus("Google-–¥ –Ω—ç–≤—Ç—Ä—ç–∂ –±–∞–π–Ω–∞...");

        // File:// protocol-–∏–π–≥ —à–∞–ª–≥–∞—Ö
        if (window.location.protocol === 'file:') {
          showError(`–§–∞–π–ª—ã–≥ —à—É—É–¥ –Ω—ç—ç–∂ –±–∞–π–Ω–∞ (file://). Google OAuth 2.0 –∞–∂–∏–ª–ª–∞—Ö–≥“Ø–π.\n\n–ó”©–≤–ª”©–º–∂:\n1. Localhost –¥—ç—ç—Ä –∞–∂–∏–ª–ª—É—É–ª–∞—Ö:\n   - Terminal/Command Prompt –Ω—ç—ç—Ö\n   - –≠–Ω—ç folder —Ä—É—É –æ—Ä–æ—Ö\n   - "python -m http.server 8000" —ç—Å–≤—ç–ª "npx http-server" –≥—ç–∂ –±–∏—á–∏—Ö\n   - Browser –¥—ç—ç—Ä "http://localhost:8000" –Ω—ç—ç—Ö\n\n2. –≠—Å–≤—ç–ª VS Code Live Server extension –∞—à–∏–≥–ª–∞—Ö`);
          return;
        }

        // gapi client –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö (—Ö—ç—Ä—ç–≤ —Ö–∏–π–≥–¥—ç—ç–≥“Ø–π –±–æ–ª)
        if (!window.gapi || !window.gapi.client || !window.gapi.client.sheets) {
          setStatus("Google API –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª–∂ –±–∞–π–Ω–∞...");
          if (!window.gapi) {
            throw new Error("Google API library –∞—á–∞–∞–ª–∞–≥–¥–∞–∞–≥“Ø–π –±–∞–π–Ω–∞. –ò–Ω—Ç–µ—Ä–Ω—ç—Ç —Ö–æ–ª–±–æ–ª—Ç —à–∞–ª–≥–∞–∞—Ä–∞–π.");
          }
          
          await new Promise((resolve, reject) => {
            window.gapi.load('client', () => {
              window.gapi.client.init({
                'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                'clientId': clientId
              }).then(() => {
                console.log("Google API client –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç–≥–¥–ª—ç—ç");
                resolve();
              }).catch(reject);
            });
          });
        }

        // OAuth token —à–∞–ª–≥–∞—Ö
        const currentToken = window.gapi.client.getToken();
        if (currentToken && currentToken.access_token) {
          setStatus("‚úÖ –ê–ª—å —Ö—ç–¥–∏–π–Ω –Ω—ç–≤—Ç—ç—Ä—Å—ç–Ω –±–∞–π–Ω–∞! –î–∞—Ä–∞–∞–≥–∏–π–Ω —É–Ω—à–∏–ª—Ç/–±–∏—á–∏–ª—Ç —Ö—É—Ä–¥–∞–Ω –±–æ–ª–Ω–æ.");
          loginGoogleBtn.textContent = "‚úÖ –ù—ç–≤—Ç—ç—Ä—Å—ç–Ω";
          loginGoogleBtn.style.background = "var(--success)";
          return;
        }

        // Token –∞–≤–∞—Ö
        setStatus("Google account-–∞–∞—Ä –Ω—ç–≤—Ç—Ä—ç—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π...");
        await new Promise((resolve, reject) => {
          const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: clientId,
            scope: 'https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/spreadsheets',
            callback: (response) => {
              if (response.error) {
                reject(new Error(`OAuth –∞–ª–¥–∞–∞: ${response.error}`));
                return;
              }
              window.gapi.client.setToken(response);
              console.log("OAuth token –∞–≤–ª–∞–∞ (login)");
              setStatus("‚úÖ –ê–º–∂–∏–ª—Ç—Ç–∞–π –Ω—ç–≤—Ç—ç—Ä–ª—ç—ç! –û–¥–æ–æ —É–Ω—à–∏–ª—Ç/–±–∏—á–∏–ª—Ç —Ö—É—Ä–¥–∞–Ω –±–æ–ª–Ω–æ.");
              loginGoogleBtn.textContent = "‚úÖ –ù—ç–≤—Ç—ç—Ä—Å—ç–Ω";
              loginGoogleBtn.style.background = "var(--success)";
              resolve();
            }
          });
          // prompt: 'select_account' - account —Å–æ–Ω–≥–æ—Ö (1 —É–¥–∞–∞), –¥–∞—Ä–∞–∞ –Ω—å cookie-–¥ —Ö–∞–¥–≥–∞–ª–∞–≥–¥–∞–Ω–∞, –∏–ª“Ø“Ø —Ö—É—Ä–¥–∞–Ω
          // prompt: 'consent' - –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–ª—Ç –¥–∞—Ö–∏–Ω –∞—Å—É—É—Ö (–æ–ª–æ–Ω —Ü–∞–≥ –∞–≤–Ω–∞)
          // prompt: '' - –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –∞—à–∏–≥–ª–∞—Ö (token –±–∞–π–≥–∞–∞ –±–æ–ª)
          tokenClient.requestAccessToken({ prompt: 'select_account' });
        });
      } catch (err) {
        console.error("Google login –∞–ª–¥–∞–∞:", err);
        if (err.message && err.message.includes('OAuth')) {
          showError(`Google account-–∞–∞—Ä –Ω—ç–≤—Ç—Ä—ç—Ö –∞–ª–¥–∞–∞:\n\n${err.message}\n\n–ó”©–≤–ª”©–º–∂:\n1. OAuth 2.0 Client ID –∑”©–≤ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö\n2. Google Cloud Console –¥—ç—ç—Ä redirect URI –∑”©–≤ —Ç–æ—Ö–∏—Ä—É—É–ª—Å–∞–Ω —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö`);
        } else {
          showError(`Google-–¥ –Ω—ç–≤—Ç—Ä—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞:\n\n${err?.message || err}\n\n–ó”©–≤–ª”©–º–∂:\n1. –ò–Ω—Ç–µ—Ä–Ω—ç—Ç —Ö–æ–ª–±–æ–ª—Ç —à–∞–ª–≥–∞—Ö\n2. OAuth 2.0 Client ID –∑”©–≤ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞—Ö`);
        }
        loginGoogleBtn.textContent = "üîê Google-–¥ –Ω—ç–≤—Ç—Ä—ç—Ö";
        loginGoogleBtn.style.background = "var(--accent)";
      }
    };

    loginGoogleBtn.addEventListener("click", loginGoogle);

    // Google Sheets —É–Ω—à–∏—Ö —Ç–æ–≤—á–Ω—ã event listener
    loadGoogleSheetsBtn.addEventListener("click", loadGoogleSheets);
    
    // PDF —Ñ–∞–π–ª—ã–≥ —Ö–∞—Ä—É—É–ª–∞—Ö —Ö—ç—Å—ç–≥
    const pdfSection = document.getElementById("pdf-section");
    const pdfViewer = document.getElementById("pdf-viewer");
    
    // –î—ç–¥ —Å—Ç–∞–Ω—Ü –±–æ–ª–æ–Ω PDF —Ñ–∞–π–ª—ã–Ω —Ö–æ–ª–±–æ–æ—Å
    const stationPdfMap = {
      "–ë—É—è–Ω—Ç –£—Ö–∞–∞": "BUYANTUHAA.pdf"
    };
    
    // –î—ç–¥ —Å—Ç–∞–Ω—Ü dropdown change event listener (–∑”©–≤—Ö”©–Ω —Ö—ç—Ä—ç–≥–ª—ç–≥—á —Å–æ–Ω–≥–æ—Å–æ–Ω “Ø–µ–¥ –ª –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä —É–Ω—à–∏—Ö)
    let lastSelectedUrl = googleSheetsUrlInput.value; // –≠—Ö–Ω–∏–π —É—Ç–≥—ã–≥ —Ö–∞–¥–≥–∞–ª–∞—Ö
    googleSheetsUrlInput.addEventListener("change", () => {
      // –ó”©–≤—Ö”©–Ω dropdown —É—Ç–≥–∞ “Ø–Ω—ç—Ö—ç—ç—Ä ”©”©—Ä—á–ª”©–≥–¥—Å”©–Ω “Ø–µ–¥ –ª —É–Ω—à–∏—Ö (page load “Ø–µ–¥ –±–∏—à)
      const currentValue = googleSheetsUrlInput.value.trim();
      if (currentValue && currentValue !== lastSelectedUrl) {
        lastSelectedUrl = currentValue;
        loadGoogleSheets();
      }
      
      // PDF —Ñ–∞–π–ª—ã–≥ –±—ç–ª—Ç–≥—ç—Ö (–∑”©–≤—Ö”©–Ω "–ù“Ø“Ø—Ä" —ç—Å–≤—ç–ª "–î—ç–¥ —Å—Ç–∞–Ω—Ü—ã–Ω —Å—Ö–µ–º" tab –¥—ç—ç—Ä –±–∞–π—Ö “Ø–µ–¥ —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞)
      const selectedOption = googleSheetsUrlInput.options[googleSheetsUrlInput.selectedIndex];
      const stationName = selectedOption.textContent.trim();
      const pdfFileName = stationPdfMap[stationName];
      
      if (pdfFileName && pdfViewer) {
        pdfViewer.src = pdfFileName;
        // –ó”©–≤—Ö”©–Ω "–ù“Ø“Ø—Ä" —ç—Å–≤—ç–ª "–î—ç–¥ —Å—Ç–∞–Ω—Ü—ã–Ω —Å—Ö–µ–º" tab –¥—ç—ç—Ä –±–∞–π—Ö “Ø–µ–¥ —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
        const activeTab = document.querySelector(".tab.active");
        if (activeTab && (activeTab.id === "tab-home" || activeTab.id === "tab-pdf")) {
          pdfSection.style.display = "block";
        }
      }
    });
    
    // –≠—Ö–ª—ç—ç–¥ —Å–æ–Ω–≥–æ—Å–æ–Ω –¥—ç–¥ —Å—Ç–∞–Ω—Ü—ã–Ω PDF —Ñ–∞–π–ª—ã–≥ –±—ç–ª—Ç–≥—ç—Ö
    if (googleSheetsUrlInput.value.trim() && pdfViewer) {
      const selectedOption = googleSheetsUrlInput.options[googleSheetsUrlInput.selectedIndex];
      const stationName = selectedOption.textContent.trim();
      const pdfFileName = stationPdfMap[stationName];
      
      if (pdfFileName) {
        pdfViewer.src = pdfFileName;
      }
    }

    // Tab switching –ª–æ–≥–∏–∫
    const tabHome = document.getElementById("tab-home");
    const tabCard = document.getElementById("tab-card");
    const tabPdf = document.getElementById("tab-pdf");
    
    const activateTab = (tabName) => {
      // –ë“Ø—Ö tabs-–∏–π–≥ inactive –±–æ–ª–≥–æ—Ö
      tabHome.classList.remove("active");
      tabCard.classList.remove("active");
      tabPdf.classList.remove("active");
      
      // –ë“Ø—Ö sections-–∏–π–≥ –Ω—É—É—Ö
      viewSection.style.display = "none";
      historySection.style.display = "none";
      pdfSection.style.display = "none";
      
      if (tabName === "home") {
        // "–ù“Ø“Ø—Ä" tab - –±“Ø—Ö –∑“Ø–π–ª —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
        tabHome.classList.add("active");
        viewSection.style.display = "block";
        historySection.style.display = "block";
        pdfSection.style.display = "block";
      } else if (tabName === "card") {
        // "–¢–∞–≤–∏–ª—ã–Ω –∫–∞—Ä—Ç" tab - –∑”©–≤—Ö”©–Ω view-section –±–æ–ª–æ–Ω history-section —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
        tabCard.classList.add("active");
        viewSection.style.display = "block";
        historySection.style.display = "block";
      } else if (tabName === "pdf") {
        // "–î—ç–¥ —Å—Ç–∞–Ω—Ü—ã–Ω —Å—Ö–µ–º" tab - –∑”©–≤—Ö”©–Ω PDF —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
        tabPdf.classList.add("active");
        pdfSection.style.display = "block";
        
        // PDF —Ñ–∞–π–ª—ã–≥ —Ö–∞—Ä—É—É–ª–∞—Ö
        if (pdfSection && pdfViewer) {
          const selectedOption = googleSheetsUrlInput.options[googleSheetsUrlInput.selectedIndex];
          const stationName = selectedOption.textContent.trim();
          const pdfFileName = stationPdfMap[stationName];
          
          if (pdfFileName) {
            pdfViewer.src = pdfFileName;
          }
        }
      }
    };
    
    tabHome.addEventListener("click", () => activateTab("home"));
    tabCard.addEventListener("click", () => activateTab("card"));
    tabPdf.addEventListener("click", () => activateTab("pdf"));

    // Page load —Ö–∏–π—Ö—ç–¥ file:// protocol-–∏–π–≥ —à–∞–ª–≥–∞—Ö
    if (window.location.protocol === 'file:') {
      const warningMsg = `‚ö†Ô∏è –§–∞–π–ª—ã–≥ —à—É—É–¥ –Ω—ç—ç–∂ –±–∞–π–Ω–∞ (file://). Google OAuth 2.0 –∞–∂–∏–ª–ª–∞—Ö–≥“Ø–π.\n\n–ó”©–≤–ª”©–º–∂:\n1. Localhost –¥—ç—ç—Ä –∞–∂–∏–ª–ª—É—É–ª–∞—Ö:\n   - Terminal/Command Prompt –Ω—ç—ç—Ö\n   - –≠–Ω—ç folder —Ä—É—É –æ—Ä–æ—Ö\n   - "python -m http.server 8000" —ç—Å–≤—ç–ª "npx http-server" –≥—ç–∂ –±–∏—á–∏—Ö\n   - Browser –¥—ç—ç—Ä "http://localhost:8000" –Ω—ç—ç—Ö\n\n2. –≠—Å–≤—ç–ª VS Code Live Server extension –∞—à–∏–≥–ª–∞—Ö`;
      setStatus(warningMsg);
      console.warn(warningMsg);
    }
  </script>
  </div>
</body>
</html>

